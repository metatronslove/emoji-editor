<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tam Emoji Sanat EditÃ¶rÃ¼</title>
    <style>
        /* GENEL VE RESET */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            min-height: 100vh;
        }

        h2 {
            color: #007bff;
            margin-bottom: 25px;
            font-weight: 600;
            text-align: center;
            width: 100%;
        }

        /* BÄ°LDÄ°RÄ°M SÄ°STEMÄ° */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        #notification.success {
            background-color: #28a745;
        }

        #notification.warning {
            background-color: #ffc107;
            color: #333;
        }

        #notification.error {
            background-color: #dc3545;
        }

        #notification.info {
            background-color: #17a2b8;
        }

        /* ONAY MODAL */
        #confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #confirm-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .modal-btn.confirm {
            background-color: #dc3545;
            color: white;
        }

        .modal-btn.confirm:hover {
            background-color: #c82333;
        }

        .modal-btn.cancel {
            background-color: #6c757d;
            color: white;
        }

        .modal-btn.cancel:hover {
            background-color: #5a6268;
        }

        /* KONTROL ALANI STÄ°LLERÄ° */
        #controls {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: center;
        }

        #controls label {
            font-weight: 500;
            white-space: nowrap;
        }

        #controls input[type="number"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            width: 60px;
        }

        #controls button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        #controls #updateMatrixButton {
            background-color: #28a745;
            color: white;
        }

        #controls #updateMatrixButton:hover {
            background-color: #218838;
        }

        #controls #copyButton, #controls #importButton {
            background-color: #007bff;
            color: white;
        }

        #controls #copyButton:hover, #controls #importButton:hover {
            background-color: #0056b3;
        }

        #controls #saveButton, #controls #loadButton {
            background-color: #ffc107;
            color: #333;
        }

        #controls #saveButton:hover, #controls #loadButton:hover {
            background-color: #e0a800;
        }

        #controls #clearButton {
            background-color: #dc3545;
            color: white;
        }

        #controls #clearButton:hover {
            background-color: #c82333;
        }

        /* BÄ°LGÄ° PANELÄ° */
        #info-panel {
            background-color: #e7f3ff;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 800px;
            text-align: center;
            border-left: 4px solid #007bff;
        }

        #info-panel .char-count {
            font-weight: 600;
            color: #007bff;
        }

        #info-panel .warning {
            color: #dc3545;
            font-weight: 500;
        }

        /* PALET STÄ°LLERÄ° */
        #palette {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 800px;
        }

        #palette strong {
            display: block;
            margin-bottom: 15px;
            color: #555;
            text-align: center;
        }

        /* SEÃ‡Ä°LÄ° EMOJÄ° EKRANI */
        #selected-emoji-display {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        #current-brush-emoji {
            font-size: 36px;
            margin-right: 10px;
            line-height: 1;
        }

        #selected-emoji-display span {
            font-weight: 600;
            color: #007bff;
        }

        /* SEKME STÄ°LLERÄ° */
        #category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            max-height: 120px;
            overflow-y: auto;
        }

        .category-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            border: 2px solid transparent;
            font-size: 14px;
            white-space: nowrap;
        }

        .category-tab:hover {
            background: #e9ecef;
        }

        .category-tab.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }

        /* EMOJÄ° KONTEYNER STÄ°LLERÄ° */
        #emoji-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: white;
        }

        #color-options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        .color-option {
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border: 3px solid transparent;
            border-radius: 6px;
            transition: transform 0.1s, border-color 0.2s;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            background-color: #f0f0f0;
        }

        .selected-color {
            border-color: #007bff;
            background-color: #e9f5ff;
            transform: scale(1.1);
        }

        .two-char-emoji {
            border: 2px dashed #ff6b6b;
        }

        .two-char-emoji::after {
            content: "2";
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* MATRÄ°S STÄ°LLERÄ° */
        #matrix-container {
            overflow-x: auto;
            margin-bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        #matrix {
            border-collapse: collapse;
            table-layout: fixed;
            background-color: #fff;
            border: 4px solid #333;
            border-radius: 5px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
        }

        #matrix td {
            width: 35px;
            height: 35px;
            text-align: center;
            vertical-align: middle;
            font-size: 20px;
            cursor: pointer;
            border: 1px solid #eee;
            transition: background-color 0.1s;
            position: relative;
        }

        #matrix td:hover {
            background-color: #f8f8f8;
        }

        /* SABÄ°T KISIMLAR Ä°Ã‡Ä°N STÄ°L */
        .fixed {
            cursor: not-allowed !important;
            background-color: #d1d1d1 !important;
            color: #aaa;
            border: 1px solid #ddd;
        }

        /* KULLANIM KILAVUZU */
        .manual {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px;
            font-size: 14px;
            color: #555;
        }

        .manual h3 {
            color: #007bff;
            margin-bottom: 15px;
            text-align: center;
        }

        .manual ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .manual li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .manual .highlight {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
        }

        /* KAYDIRMA Ã‡UBUÄU STÄ°LLERÄ° */
        #emoji-container::-webkit-scrollbar,
        #category-tabs::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #emoji-container::-webkit-scrollbar-track,
        #category-tabs::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #emoji-container::-webkit-scrollbar-thumb,
        #category-tabs::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        #emoji-container::-webkit-scrollbar-thumb:hover,
        #category-tabs::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* RESPONSIVE DÃœZENLEMELER */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            #controls {
                padding: 15px;
                gap: 8px;
            }

            #controls button {
                padding: 8px 12px;
                font-size: 14px;
            }

            #matrix td {
                width: 30px;
                height: 30px;
                font-size: 18px;
            }

            .color-option {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .category-tab {
                padding: 6px 12px;
                font-size: 13px;
            }

            #emoji-container {
                max-height: 200px;
            }

            #notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            #controls {
                flex-direction: column;
                align-items: stretch;
            }

            #controls > * {
                width: 100%;
                margin-bottom: 8px;
            }

            #matrix td {
                width: 25px;
                height: 25px;
                font-size: 16px;
            }

            .color-option {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }

            #category-tabs {
                gap: 4px;
            }

            .category-tab {
                padding: 4px 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

    <div id="notification"></div>

    <div id="confirm-modal">
        <div class="modal-content">
            <h3 id="modal-title">Emin misiniz?</h3>
            <p id="modal-message">Bu iÅŸlem geri alÄ±namaz.</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" id="modal-confirm">Evet</button>
                <button class="modal-btn cancel" id="modal-cancel">Ä°ptal</button>
            </div>
        </div>
    </div>

    <h2>Tam Emoji Sanat EditÃ¶rÃ¼</h2>

    <div class="manual">
        <h3>ğŸ“– YouTube Sohbeti Ä°Ã§in KullanÄ±m KÄ±lavuzu</h3>

        <div class="highlight">
            <strong>ğŸ¯ Ã–NEMLÄ°:</strong> Ä°lk satÄ±r uzunluÄŸunu doÄŸru belirlemek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:
        </div>

        <ol>
            <li><strong>Ã‡izime baÅŸlamadan Ã¶nce</strong> "Panoya Kopyala" butonuna basÄ±n</li>
            <li>YouTube sohbet kutusuna <strong>100 adet siyah kalp yapÄ±ÅŸtÄ±rÄ±n</strong> (ğŸ–¤)</li>
            <li>Bu mesajÄ± <strong>gÃ¶nderin</strong> ve sohbette gÃ¶rÃ¼nmesini bekleyin</li>
            <li>GÃ¶nderdiÄŸiniz mesajda, <strong>nickname'inizin yanÄ±nda gÃ¶rÃ¼nen kalp sayÄ±sÄ±nÄ± sayÄ±n</strong></li>
            <li>Bu sayÄ±yÄ± "Ä°lk SatÄ±r UzunluÄŸu" olarak ayarlayÄ±n</li>
            <li>ArtÄ±k Ã§iziminizi yapmaya baÅŸlayabilirsiniz!</li>
        </ol>

        <p><strong>ğŸ’¡ Ä°pucu:</strong> Ä°lk satÄ±r uzunluÄŸu, YouTube sohbetinde nickname'inizin yanÄ±nda gÃ¶rÃ¼necek kalp sayÄ±sÄ±nÄ± belirler. DoÄŸru ayarlandÄ±ÄŸÄ±nda Ã§iziminiz nickname'inizin hemen yanÄ±nda baÅŸlayacaktÄ±r.</p>
    </div>

    <div id="info-panel">
        <span class="char-count">KullanÄ±lan Karakter: <span id="currentChars">0</span>/200</span>
        <span id="charWarning" class="warning" style="display: none;"> - âš ï¸ 2 karakterlik emoji kullanÄ±yorsunuz!</span>
    </div>

    <div id="controls">
        <label for="firstRowLength">Ä°lk SatÄ±r UzunluÄŸu (0-11):</label>
        <input type="number" id="firstRowLength" value="6" min="0" max="11">
        <button id="updateMatrixButton">Matrisi GÃ¼ncelle</button>
        <button id="copyButton">Panoya Kopyala</button>
        <button id="importButton">Panodan Ä°Ã§e Aktar</button>
        <button id="saveButton">Ã‡izimi Kaydet</button>
        <input type="file" id="fileInput" accept=".txt" style="display: none;">
        <button id="loadButton">Dosya AÃ§</button>
        <button id="clearButton">Temizle</button>
    </div>

    <div id="palette">
        <strong>FÄ±rÃ§a Rengi SeÃ§in:</strong>

        <div id="selected-emoji-display">
            <span style="font-weight: normal;">SeÃ§ili Emoji:</span>
            <span id="current-brush-emoji">ğŸ–¤</span>
            <span id="current-brush-name"> (black heart)</span>
        </div>

        <div id="category-tabs">
            </div>

        <div id="emoji-container">
            <div id="color-options-container">
                </div>
        </div>
    </div>

    <div id="matrix-container">
        <table id="matrix">
            </table>
    </div>

    <script>
        // --- TEMEL TANIMLAMALAR ---
        const MATRIX_WIDTH = 11;
        const MATRIX_HEIGHT = 10;
        const MAX_CHARACTERS = 200; // YouTube karakter limiti
        const EMOJI_JSON_URL = 'emoji.json'; // AynÄ± dizindeki dosya adÄ±
        const defaultHeart = 'ğŸ–¤';

        // Bu nesne artÄ±k dinamik olarak doldurulacak
        let emojiCategories = {};
        let selectedHeart = { emoji: defaultHeart, chars: 1, name: 'black heart' }; // 'name' alanÄ± eklendi
        let currentCategory = "";
        let twoCharEmojisUsed = 0;

        // --- DOM ELEMENTLERÄ° ---
        const firstRowLengthInput = document.getElementById('firstRowLength');
        const updateMatrixButton = document.getElementById('updateMatrixButton');
        const matrixTable = document.getElementById('matrix');
        const colorOptionsContainer = document.getElementById('color-options-container');
        const categoryTabsContainer = document.getElementById('category-tabs');
        const copyButton = document.getElementById('copyButton');
        const importButton = document.getElementById('importButton');
        const saveButton = document.getElementById('saveButton');
        const loadButton = document.getElementById('loadButton');
        const fileInput = document.getElementById('fileInput');
        const clearButton = document.getElementById('clearButton');
        const currentCharsSpan = document.getElementById('currentChars');
        const charWarningSpan = document.getElementById('charWarning');
        const notification = document.getElementById('notification');
        const confirmModal = document.getElementById('confirm-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');

        // YENÄ° ELEMANLAR
        const currentBrushEmoji = document.getElementById('current-brush-emoji');
        const currentBrushName = document.getElementById('current-brush-name');


        // --- BÄ°LDÄ°RÄ°M VE MODAL SÄ°STEMÄ° (DeÄŸiÅŸtirilmedi) ---

        /**
         * Bildirim gÃ¶sterir
         */
        function showNotification(message, type = 'info', duration = 3000) {
            notification.textContent = message;
            notification.className = '';
            notification.classList.add(type);
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        /**
         * Onay modalÄ±nÄ± gÃ¶sterir
         */
        function showConfirm(title, message) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmModal.classList.add('show');

                modalConfirm.onclick = () => {
                    confirmModal.classList.remove('show');
                    resolve(true);
                };

                modalCancel.onclick = () => {
                    confirmModal.classList.remove('show');
                    resolve(false);
                };
            });
        }

        // --- EMOJÄ° YÃœKLEME VE Ä°ÅLEME FONKSÄ°YONLARI ---

        /**
         * Emojinin gÃ¶rsel geniÅŸliÄŸini (1 veya 2 karakter) hesaplar.
         */
        function calculateChatChars(emojiString) {
            // Bayraklar ve ZWJ (Zero Width Joiner) kombinasyonlarÄ± genellikle 2 gÃ¶rsel geniÅŸliktedir.
            if (emojiString.length > 2) {
                return 2;
            }
            // Tekil emojiler (kalpler, yÃ¼zler vb.) 1 gÃ¶rsel geniÅŸliktedir.
            return 1;
        }

        /**
         * Harici JSON dosyasÄ±nÄ± yÃ¼kler ve emojiCategories nesnesini doldurur.
         */
        async function loadEmojis() {
            try {
                const response = await fetch(EMOJI_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP Hata kodu: ${response.status}`);
                }
                const rawEmojis = await response.json();

                let processedCategories = {};

                rawEmojis.forEach(item => {
                    const categoryName = item.category || "Uncategorized";
                    const emojiName = item.description || item.names[0];

                    if (!processedCategories[categoryName]) {
                        processedCategories[categoryName] = {};
                    }

                    processedCategories[categoryName][emojiName] = {
                        emoji: item.emoji,
                        chars: calculateChatChars(item.emoji),
                        name: emojiName // Ä°sim eklendi
                    };
                });

                emojiCategories = processedCategories;

                // Ä°lk kategoriyi ayarla (en Ã§ok emojisi olan kategori)
                const sortedCategories = Object.keys(emojiCategories).sort((a, b) =>
                    Object.keys(emojiCategories[b]).length - Object.keys(emojiCategories[a]).length
                );
                currentCategory = sortedCategories[0];

                showNotification(`âœ… ${rawEmojis.length} adet emoji baÅŸarÄ±yla yÃ¼klendi!`, 'success');

            } catch (error) {
                console.error("Emoji yÃ¼kleme hatasÄ±:", error);
                showNotification('âŒ Emoji yÃ¼klenemedi. "emoji.json" dosyasÄ±nÄ±n mevcut ve doÄŸru formatta olduÄŸundan emin olun.', 'error', 8000);
            }
        }

        // --- MATRÄ°S VE HESAPLAMA FONKSÄ°YONLARI (DeÄŸiÅŸtirilmedi) ---

        /**
         * Matrisi oluÅŸturur ve varsayÄ±lan siyah kalplerle doldurur.
         */
        function createMatrix() {
            matrixTable.innerHTML = ''; // Temizle
            const firstRowLength = parseInt(firstRowLengthInput.value);

            // Son satÄ±rÄ±n dÃ¼zenlenebilir uzunluÄŸunu hesapla
            const lastRowLength = calculateLastRowLength(firstRowLength);

            // TÃ¼m satÄ±rlarÄ± oluÅŸtur
            for (let rowIndex = 0; rowIndex < MATRIX_HEIGHT; rowIndex++) {
                const row = matrixTable.insertRow();

                for (let colIndex = 0; colIndex < MATRIX_WIDTH; colIndex++) {
                    const cell = row.insertCell();
                    let isFixed = false;

                    // 1. SatÄ±r iÃ§in sabit kÄ±sÄ±mlarÄ± belirle
                    if (rowIndex === 0) {
                        const leadingEmptyCells = MATRIX_WIDTH - firstRowLength;
                        if (colIndex < leadingEmptyCells) {
                            isFixed = true;
                        }
                    }
                    // 10. SatÄ±r iÃ§in sabit kÄ±sÄ±mlarÄ± belirle
                    else if (rowIndex === 9) {
                        const fixedCells = MATRIX_WIDTH - lastRowLength;
                        if (colIndex >= lastRowLength) {
                            isFixed = true;
                        }
                    }

                    if (isFixed) {
                        cell.innerHTML = 'âŒ';
                        cell.classList.add('fixed');
                    } else {
                        cell.innerHTML = defaultHeart;
                        cell.setAttribute('data-chars', '1');
                        cell.addEventListener('click', () => {
                            handleCellClick(cell);
                        });
                    }
                    cell.setAttribute('data-row', rowIndex);
                    cell.setAttribute('data-col', colIndex);
                }
            }
            updateCharacterCount();
        }

        /**
         * Son satÄ±r uzunluÄŸunu hesaplar
         */
        function calculateLastRowLength(firstRowLength) {
            const baseEditableCells = 100;
            const middleRowsCells = 8 * MATRIX_WIDTH; // 88 hÃ¼cre
            const usedByFirstRow = firstRowLength;

            // 2 karakterlik emojiler iÃ§in ekstra alan hesabÄ±
            const extraSpaceNeeded = twoCharEmojisUsed;

            let lastRowLength = baseEditableCells - usedByFirstRow - middleRowsCells;
            lastRowLength = Math.max(0, lastRowLength - extraSpaceNeeded);

            return Math.min(MATRIX_WIDTH, lastRowLength);
        }

        /**
         * HÃ¼cre tÄ±klama iÅŸleyicisi
         */
        function handleCellClick(cell) {
            if (cell.classList.contains('fixed')) return;

            const previousChars = parseInt(cell.getAttribute('data-chars') || '1');
            const newChars = selectedHeart.chars;

            // Karakter deÄŸiÅŸimini gÃ¼ncelle
            if (previousChars === 2 && newChars === 1) {
                twoCharEmojisUsed--;
            } else if (previousChars === 1 && newChars === 2) {
                twoCharEmojisUsed++;
            }

            cell.innerHTML = selectedHeart.emoji;
            cell.setAttribute('data-chars', newChars.toString());

            // Matrisi yeniden dÃ¼zenle (sabit hÃ¼cre sayÄ±sÄ±nÄ± gÃ¼ncelle)
            reorganizeMatrix();
            updateCharacterCount();
        }

        /**
         * Matrisi yeniden dÃ¼zenler (2 karakterlik emojilere gÃ¶re)
         */
        function reorganizeMatrix() {
            const firstRowLength = parseInt(firstRowLengthInput.value);
            const lastRowLength = calculateLastRowLength(firstRowLength);

            // Son satÄ±rÄ± gÃ¼ncelle
            const lastRow = matrixTable.rows[9];
            const cells = lastRow.cells;

            for (let colIndex = 0; colIndex < MATRIX_WIDTH; colIndex++) {
                const cell = cells[colIndex];

                if (colIndex >= lastRowLength) {
                    // Sabit hÃ¼cre yap
                    if (!cell.classList.contains('fixed')) {
                        cell.innerHTML = 'âŒ';
                        cell.classList.add('fixed');
                        cell.removeAttribute('data-chars');
                        cell.onclick = null;
                    }
                } else {
                    // DÃ¼zenlenebilir hÃ¼cre yap (eÄŸer sabitse)
                    if (cell.classList.contains('fixed')) {
                        cell.innerHTML = defaultHeart;
                        cell.classList.remove('fixed');
                        cell.setAttribute('data-chars', '1');
                        cell.addEventListener('click', () => {
                            handleCellClick(cell);
                        });
                    }
                }
            }
        }

        /**
         * Karakter sayÄ±sÄ±nÄ± gÃ¼nceller
         */
        function updateCharacterCount() {
            let totalChars = 0;
            const rows = matrixTable.rows;

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].cells;
                for (let j = 0; j < cells.length; j++) {
                    if (!cells[j].classList.contains('fixed')) {
                        const chars = parseInt(cells[j].getAttribute('data-chars') || '1');
                        totalChars += chars;
                    }
                }
            }

            currentCharsSpan.textContent = totalChars;

            // UyarÄ± gÃ¶ster/gizle
            if (twoCharEmojisUsed > 0) {
                charWarningSpan.style.display = 'inline';
                charWarningSpan.textContent = ` - âš ï¸ ${twoCharEmojisUsed} adet 2 karakterlik emoji kullanÄ±yorsunuz!`;
            } else {
                charWarningSpan.style.display = 'none';
            }

            // Limit aÅŸÄ±mÄ± uyarÄ±sÄ±
            if (totalChars > MAX_CHARACTERS) {
                currentCharsSpan.style.color = '#dc3545';
                charWarningSpan.innerHTML += ' <strong>âš ï¸ LIMIT AÅILDI!</strong>';
            } else {
                currentCharsSpan.style.color = '#007bff';
            }
        }

        // --- PALET VE SEKMELERÄ°N YENÄ° VERSÄ°YONLARI ---

        /**
         * SeÃ§ili fÄ±rÃ§a emojisini gÃ¼nceller.
         */
        function updateSelectedEmojiDisplay() {
            currentBrushEmoji.textContent = selectedHeart.emoji;
            currentBrushName.textContent = ` (${selectedHeart.name})`;

            // TÃ¼m emoji seÃ§eneklerinin 'selected-color' sÄ±nÄ±fÄ±nÄ± kaldÄ±r
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected-color'));

            // Yeni seÃ§ilen emojiyi bul ve iÅŸaretle
            const activeOption = document.querySelector(`[data-color="${selectedHeart.name}"][data-category-name="${currentCategory}"]`);
            if (activeOption) {
                 activeOption.classList.add('selected-color');
            }
        }


        /**
         * Kategori sekmelerini oluÅŸturur.
         */
        function createCategoryTabs() {
            categoryTabsContainer.innerHTML = ''; // Temizle

            // Her kategori iÃ§in bir sekme oluÅŸtur
            Object.keys(emojiCategories).forEach(categoryName => {
                const tabButton = document.createElement('button');
                tabButton.className = 'category-tab';
                tabButton.textContent = `${categoryName} (${Object.keys(emojiCategories[categoryName]).length})`;
                tabButton.setAttribute('data-category', categoryName);

                // Aktif kategoriyi iÅŸaretle
                if (categoryName === currentCategory) {
                    tabButton.classList.add('active');
                }

                // TÄ±klama olayÄ±
                tabButton.addEventListener('click', () => {
                    // Ã–nceki aktif sekme sÄ±nÄ±fÄ±nÄ± kaldÄ±r
                    document.querySelectorAll('.category-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    // Yeni aktif sekme sÄ±nÄ±fÄ±nÄ± ekle
                    tabButton.classList.add('active');
                    // Kategoriyi deÄŸiÅŸtir
                    currentCategory = categoryName;
                    // Emoji paletini gÃ¼ncelle
                    createPalette();
                });

                categoryTabsContainer.appendChild(tabButton);
            });
        }

        /**
         * Emoji paletini oluÅŸturur (seÃ§ili kategoriye gÃ¶re).
         */
        function createPalette() {
            colorOptionsContainer.innerHTML = ''; // Temizle

            if (!currentCategory || !emojiCategories[currentCategory]) {
                return;
            }

            const emojisToShow = emojiCategories[currentCategory];

            // SeÃ§ili kategorideki tÃ¼m emojileri ekle
            Object.entries(emojisToShow).forEach(([name, emojiData]) => {
                const span = document.createElement('span');
                span.className = 'color-option';

                // 2 karakterlik emoji uyarÄ±sÄ±
                if (emojiData.chars === 2) {
                    span.classList.add('two-char-emoji');
                }

                span.innerHTML = emojiData.emoji;
                span.title = `${name} (${emojiData.chars} karakter)`;
                span.setAttribute('data-color', name);
                span.setAttribute('data-chars', emojiData.chars.toString());
                span.setAttribute('data-category-name', currentCategory); // Yeni: SeÃ§im takibi iÃ§in kategori adÄ±

                // SeÃ§ili emojiyse iÅŸaretle
                if (emojiData.emoji === selectedHeart.emoji && emojiData.name === selectedHeart.name) {
                     span.classList.add('selected-color');
                }

                // TÄ±klama iÅŸlevi
                span.addEventListener('click', () => {
                    // SeÃ§ili emojiyi ayarla
                    selectedHeart = emojiData;
                    updateSelectedEmojiDisplay();
                });

                colorOptionsContainer.appendChild(span);
            });

            // EÄŸer seÃ§ili kalp, yeni kategoriye taÅŸÄ±ndÄ±ysa veya varsayÄ±lan deÄŸilse, tekrar iÅŸaretle.
            updateSelectedEmojiDisplay();
        }

        // --- DÄ°ÄER FONKSÄ°YONLAR (DeÄŸiÅŸtirilmedi) ---

        /**
         * Ã‡izimi dÃ¼z emoji metni olarak dÃ¶ndÃ¼rÃ¼r (sadece deÄŸiÅŸtirilebilir hÃ¼creler).
         */
        function getDrawingText(formatted = false) {
            let result = [];
            const rows = matrixTable.rows;

            for (let i = 0; i < rows.length; i++) {
                let rowText = '';
                const cells = rows[i].cells;

                for (let j = 0; j < cells.length; j++) {
                    // Sadece deÄŸiÅŸtirilebilir hÃ¼creleri dahil et
                    if (!cells[j].classList.contains('fixed')) {
                        rowText += cells[j].innerHTML;
                    }
                }

                if (rowText) { // BoÅŸ satÄ±rlarÄ± ekleme
                    result.push(rowText);
                }
            }

            return formatted ? result.join('\n') : result.join('');
        }

        /**
         * Ã‡izimi matrise uygular (2 karakterlik emoji desteÄŸi ile)
         */
        function applyDrawingText(text) {
            const cleanText = text.replace(/[\s\n\r]/g, '');
            const editableCellCount = getEditableCellCount();

            // Matrisin hÃ¼cre sayÄ±sÄ±ndan daha fazla karakter varsa hata ver
            if (cleanText.length > editableCellCount) {
                 showNotification(`Hata: Ä°Ã§e aktarÄ±lan metin en fazla ${editableCellCount} gÃ¶rsel karaktere eÅŸdeÄŸer olmalÄ±. LÃ¼tfen matrisi temizleyin veya boyutlarÄ± gÃ¼ncelleyin.`, 'error', 5000);
                 return false;
            }

            // 2 karakterlik emoji sayÄ±sÄ±nÄ± sÄ±fÄ±rla
            twoCharEmojisUsed = 0;

            let charIndex = 0;
            const rows = matrixTable.rows;

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].cells;

                for (let j = 0; j < cells.length; j++) {
                    const cell = cells[j];

                    if (!cell.classList.contains('fixed') && charIndex < cleanText.length) {

                        let currentEmoji = cleanText[charIndex];
                        let emojiLength = 1;

                        let tempString = cleanText.substring(charIndex);
                        let detectedLength = 1;
                        let foundEmoji = null;

                        // TÃ¼m emojilerde dÃ¶nerek eÅŸleÅŸme arÄ±yoruz (en gÃ¼venilir yol)
                        Object.values(emojiCategories).some(category => {
                            return Object.values(category).some(data => {
                                // Emoji verisi (data.emoji) string'in baÅŸÄ±nda eÅŸleÅŸiyor mu?
                                if (tempString.startsWith(data.emoji)) {
                                    foundEmoji = data;
                                    detectedLength = data.chars;
                                    return true;
                                }
                            });
                        });

                        if (foundEmoji) {
                            emojiLength = foundEmoji.emoji.length; // GerÃ§ek JavaScript string uzunluÄŸu
                            if (detectedLength === 2) {
                                twoCharEmojisUsed += 1; // GÃ¶rsel geniÅŸlik 2
                            }
                        } else {
                            // Listedeki emojilerle eÅŸleÅŸmezse, tek karakter olarak kabul et
                            emojiLength = 1;
                            detectedLength = 1;
                        }

                        cell.innerHTML = cleanText.substring(charIndex, charIndex + emojiLength);
                        cell.setAttribute('data-chars', detectedLength.toString());
                        charIndex += emojiLength;

                    } else if (!cell.classList.contains('fixed') && charIndex >= cleanText.length) {
                        // Geri kalan boÅŸluklarÄ± varsayÄ±lan kalp ile doldur
                        cell.innerHTML = defaultHeart;
                        cell.setAttribute('data-chars', '1');
                    }
                }
            }

            reorganizeMatrix();
            updateCharacterCount();
            return true;
        }

        /**
         * DeÄŸiÅŸtirilebilir hÃ¼cre sayÄ±sÄ±nÄ± hesaplar
         */
        function getEditableCellCount() {
            const firstRowLength = parseInt(firstRowLengthInput.value);
            return firstRowLength + (8 * MATRIX_WIDTH) + MATRIX_WIDTH;
        }

        // --- OLAY DÄ°NLEYÄ°CÄ°LERÄ° (DeÄŸiÅŸtirilmedi) ---

        // Matrisi GÃ¼ncelle butonu
        updateMatrixButton.addEventListener('click', async () => {
            const confirmed = await showConfirm(
                "Matrisi GÃ¼ncelle",
                "Ä°lk satÄ±r uzunluÄŸunu deÄŸiÅŸtirmek mevcut Ã§izimi temizleyecektir. Devam etmek istiyor musunuz?"
            );

            if (confirmed) {
                twoCharEmojisUsed = 0;
                createMatrix();
                showNotification('Matris baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
            }
        });

        // Panoya Kopyala
        copyButton.addEventListener('click', async () => {
            const drawingText = getDrawingText(false);
            const totalChars = parseInt(currentCharsSpan.textContent);

            if (totalChars > MAX_CHARACTERS) {
                showNotification(`âš ï¸ UYARI: Ã‡iziminiz ${totalChars} karakter iÃ§eriyor (limit: ${MAX_CHARACTERS}). YouTube'da kesilebilir.`, 'warning', 4000);
                return;
            }

            try {
                await navigator.clipboard.writeText(drawingText);
                showNotification(`âœ… Ã‡izim panoya kopyalandÄ±! (${totalChars}/${MAX_CHARACTERS} karakter)`, 'success');
            } catch (err) {
                console.error('Kopyalama baÅŸarÄ±sÄ±z:', err);
                showNotification('âŒ Kopyalama baÅŸarÄ±sÄ±z oldu. LÃ¼tfen tarayÄ±cÄ± izinlerini kontrol edin.', 'error');
            }
        });

        // Panodan Ä°Ã§e Aktar
        importButton.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (applyDrawingText(text)) {
                    showNotification('âœ… Ã‡izim panodan baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!', 'success');
                }
            } catch (err) {
                console.error('Ä°Ã§e aktarma baÅŸarÄ±sÄ±z:', err);
                showNotification('âŒ Ä°Ã§e aktarma baÅŸarÄ±sÄ±z oldu. Panonuzda geÃ§erli bir Ã§izim metni olduÄŸundan emin olun.', 'error');
            }
        });

        // Kaydet
        saveButton.addEventListener('click', () => {
            const drawingText = getDrawingText(true);
            const blob = new Blob([drawingText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'emoji_cizimi.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('ğŸ’¾ Ã‡izim baÅŸarÄ±yla kaydedildi!', 'success');
        });

        // Dosya AÃ§
        loadButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    if (applyDrawingText(text)) {
                        showNotification('âœ… Ã‡izim dosyadan baÅŸarÄ±yla yÃ¼klendi!', 'success');
                    }
                };
                reader.readAsText(file);
                // Input'u temizle
                event.target.value = '';
            }
        });

        // Temizle
        clearButton.addEventListener('click', async () => {
            const confirmed = await showConfirm(
                "Ã‡izimi Temizle",
                "Mevcut Ã§izimi temizlemek istediÄŸinizden emin misiniz?"
            );

            if (confirmed) {
                twoCharEmojisUsed = 0;
                createMatrix();
                showNotification('ğŸ§¹ Ã‡izim temizlendi!', 'success');
            }
        });

        // --- BAÅLANGIÃ‡ ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Emojileri yÃ¼kle ve iÅŸle
            await loadEmojis();

            // 2. ArayÃ¼zÃ¼ baÅŸlat (SÄ±ra Ã¶nemlidir!)
            if (Object.keys(emojiCategories).length > 0) {
                // Siyah kalp emojisini default olarak bul ve ayarla
                Object.values(emojiCategories).some(category => {
                    return Object.values(category).some(data => {
                        if (data.emoji === defaultHeart) {
                            selectedHeart = data;
                            return true;
                        }
                    });
                });

                // SeÃ§ili emoji ekranÄ±nÄ± baÅŸlat
                updateSelectedEmojiDisplay();

                createMatrix();
                createCategoryTabs();
                createPalette();
                showNotification('ğŸ¨ TÃ¼m Emoji Kategorileri YÃ¼klendi! BaÅŸlayÄ±n.', 'info', 3000);
            } else {
                showNotification('âŒ Uygulama baÅŸlatÄ±lamadÄ±. Emoji verisi yÃ¼klenemedi.', 'error', 5000);
            }
        });
    </script>
</body>
</html>
