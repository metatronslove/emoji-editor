<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalp Emoji Piksel SanatÄ± EditÃ¶rÃ¼</title>
    <style>
        /*
        ========================================
        1. TEMEL VE TEMA TANIMLARI (DARK/LIGHT)
        ========================================
        */
        :root {
            /* Light Mode VarsayÄ±lanlarÄ± */
            --bg-color-light: #f0f3f8;
            --main-text-light: #2c3e50;
            --accent-color-light: #007bff;
            --card-bg-light: rgba(255, 255, 255, 0.85);
            --border-color-light: #e0e6ed;
            --fixed-bg-light: #d4e3f5;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode AyarlarÄ± */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a2e;
                --main-text: #e0eaf1;
                --accent-color: #3f72af; /* Mavi-Mor Tonu */
                --card-bg: rgba(25, 25, 45, 0.85);
                --border-color: #3b3b64;
                --fixed-bg: #2c2c4d;
                --shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            }
        }

        /* Fallback ve Light Mode Uygulama */
        :root {
            --bg-color: var(--bg-color-light);
            --main-text: var(--main-text-light);
            --accent-color: var(--accent-color-light);
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-color-light);
            --fixed-bg: var(--fixed-bg-light);
            --shadow: var(--shadow-light);
        }

        /* Zorunlu Dark Mode (JS ile eklenecek) */
        body.dark-mode {
            --bg-color: #1a1a2e;
            --main-text: #e0eaf1;
            --accent-color: #3f72af;
            --card-bg: rgba(25, 25, 45, 0.85);
            --border-color: #3b3b64;
            --fixed-bg: #2c2c4d;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        /*
        ========================================
        2. ANATOMÄ° VE ARKA PLAN
        ========================================
        */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Space Mono', 'Segoe UI', monospace, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            color: var(--main-text);
            background-color: var(--bg-color);
            transition: background-color 0.5s, color 0.5s;
            position: relative;
            z-index: 1;
        }

        /* FÃ¼tÃ¼ristik Hareketli Arka Plan */
        #background-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.1;
            background:
                linear-gradient(to right, var(--accent-color) 1px, transparent 1px) 0 0,
                linear-gradient(to bottom, var(--accent-color) 1px, transparent 1px) 0 0;
            background-size: 50px 50px;
            animation: grid-flow 60s linear infinite;
        }

        @keyframes grid-flow {
            from { background-position: 0 0; }
            to { background-position: 500px 500px; }
        }

        h2 {
            color: var(--accent-color);
            margin-bottom: 25px;
            font-weight: 700;
            text-align: center;
            width: 100%;
            text-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
            z-index: 2;
        }

        /* Ana Ä°Ã§erik Konteyneri (Desktop YerleÅŸimi iÃ§in) */
        #main-layout {
            display: flex;
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            z-index: 2;
            margin-top: 15px;
        }

        /*
        ========================================
        3. BÄ°LEÅEN STÄ°LLERÄ° (CARD, MATRÄ°S, PALET, MODAL)
        ========================================
        */
        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            transition: background-color 0.5s, border-color 0.5s;
            width: 100%;
        }

        /* Sol Kontrol Paneli (SADECE PALETÄ° Ä°Ã‡ERÄ°R) */
        #left-panel {
            width: 350px;
            flex-shrink: 0;
        }

        /* SaÄŸ Ana Alan (Matris, Bilgi VE KONTROLLER) */
        #right-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* KONTROL PANELÄ° STÄ°LÄ° */
        #controls-panel {
            max-width: 600px;
            margin: 0 auto 20px auto;
            width: 100%;
        }

        /* KÄ±lavuz ve Onay Modal Stilleri */
        #guide-modal, #confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #guide-modal.show, #confirm-modal.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content, .modal-content-guide {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 90%;
            text-align: left;
            border: 2px solid var(--accent-color);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s;
        }

        .modal-btn.confirm { background-color: #28a745; }
        .modal-btn.cancel { background-color: #dc3545; }
        .modal-btn.confirm:hover { background-color: #218838; }
        .modal-btn.cancel:hover { background-color: #c82333; }

        #close-guide-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        /* Bilgi Paneli */
        #info-panel {
            background-color: var(--fixed-bg);
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 800px;
            text-align: center;
            border-left: 4px solid var(--accent-color);
            font-size: 0.9em;
        }

        /* Kontrol ButonlarÄ± */
        #main-controls, #auxiliary-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        /* AyÄ±rÄ±cÄ± SeÃ§imi Stili */
        #separator-select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--fixed-bg);
            color: var(--main-text);
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
        }

        /* DÃ¼ÄŸme stilleri */
        #controls-panel button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            color: var(--main-text);
        }

        .btn-primary { background-color: var(--accent-color); color: white !important;}
        .btn-primary:hover { opacity: 0.85; }
        .btn-success { background-color: #28a745; color: white !important;}
        .btn-success:hover { background-color: #218838; }
        .btn-warning { background-color: #ffc107; color: var(--main-text) !important;}
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: #dc3545; color: white !important;}
        .btn-danger:hover { background-color: #c82333; }

        /* Matris stilleri */
        #matrix-container {
            overflow-x: auto;
            margin-bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        #matrix {
            border-collapse: collapse;
            table-layout: fixed;
            background-color: var(--card-bg);
            border: 4px solid var(--accent-color);
            border-radius: 8px;
            box-shadow: 0 0 20px var(--accent-color), 0 8px 25px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
            transition: background-color 0.5s, border-color 0.5s, box-shadow 0.5s;
        }

        #matrix td {
            width: 35px;
            height: 35px;
            text-align: center;
            vertical-align: middle;
            font-size: 20px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: background-color 0.1s, border-color 0.5s;
        }

        .fixed {
            cursor: not-allowed !important;
            background-color: var(--fixed-bg) !important;
            color: var(--main-text);
            border: 1px solid var(--border-color);
            opacity: 0.7;
        }

        /* Palet Stilleri */
        #palette strong {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--accent-color);
        }

        #selected-emoji-display {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
            padding: 8px;
            border-radius: 4px;
            background-color: var(--fixed-bg);
        }

        #current-brush-emoji {
            font-size: 24px;
        }

        #category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .category-tab {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--fixed-bg);
            color: var(--main-text);
            font-size: 0.85em;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .category-tab.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        #color-options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }

        .color-option {
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: border-color 0.1s;
            position: relative;
        }

        .color-option:hover {
            border-color: var(--accent-color);
        }

        .color-option.selected-color {
            border-color: #ffc107;
            box-shadow: 0 0 5px #ffc107;
        }

        .two-char-emoji:before {
            content: '2';
            position: absolute;
            font-size: 8px;
            color: #ff6b6b;
            transform: translate(12px, -8px);
            font-weight: bold;
        }

        /* BÄ°LDÄ°RÄ°M SÄ°STEMÄ° */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 18px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        #notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        #notification.info { background-color: #3f72af; }
        #notification.success { background-color: #28a745; }
        #notification.warning { background-color: #ffc107; color: #333; }
        #notification.error { background-color: #dc3545; }


        /*
        ========================================
        4. RESPONSIVE DÃœZENLEMELER
        ========================================
        */
        @media (max-width: 1024px) {
            #main-layout {
                flex-direction: column;
                gap: 0;
            }
            #left-panel {
                width: 100%;
            }
            #controls-panel {
                max-width: 100%;
                margin: 0 0 20px 0;
            }
        }

        @media (max-width: 600px) {
            #controls-panel > div {
                flex-direction: column;
                align-items: stretch;
            }
            #controls-panel button, #controls-panel input, #controls-panel label, #separator-select {
                width: 100%;
            }
            #auxiliary-controls {
                 flex-direction: row !important;
            }
            #auxiliary-controls button {
                 flex-grow: 1;
            }
        }
    </style>
</head>
<body>

    <div id="background-grid"></div>

    <div id="notification"></div>

    <div id="confirm-modal">
        <div class="modal-content">
            <h3 id="modal-title">Emin misiniz?</h3>
            <p id="modal-message">Bu iÅŸlem geri alÄ±namaz.</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" id="modal-confirm">Evet</button>
                <button class="modal-btn cancel" id="modal-cancel">Ä°ptal</button>
            </div>
        </div>
    </div>

    <div id="guide-modal">
        <div class="modal-content-guide">
            <h3>ğŸ“– YouTube Sohbet KÄ±lavuzu</h3>

            <div style="background-color: var(--fixed-bg); padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid var(--accent-color);">
                <strong>ğŸ¯ Ã–NEMLÄ°:</strong> **Filtre Atlatma YÃ¶ntemi**'ni kullanmak, **Ã§izim alanÄ±nÄ±zÄ± (matrisinizi) kÄ±sÄ±tlar**.
            </div>

            <ol style="margin-left: 20px; font-size: 0.95em;">
                <li style="margin-bottom: 8px;">**KÄ±lavuz AdÄ±m 1 (Ä°lk SatÄ±r AyarÄ±):** YouTube'da 100 adet **ğŸ–¤** gÃ¶nderin. Nickname'inizin yanÄ±nda gÃ¶rÃ¼nen kalp sayÄ±sÄ±nÄ± sayÄ±n. Bu sayÄ±yÄ± **"Ä°lk SatÄ±r UzunluÄŸu"** olarak girin ve **Matrisi GÃ¼ncelle**'ye basÄ±n.</li>
                <li style="margin-bottom: 8px;">**KÄ±lavuz AdÄ±m 2 (Spam Filtresi):** Ã‡iziminizin YouTube sohbetinde gÃ¶rÃ¼nmemesi durumunda, **Filtre Atlatma YÃ¶ntemi**'ni sÄ±rayla deneyin.
                    <ul>
                        <li>**HiÃ§biri:** En fazla piksel (100+), matris boyutu **11x10**.</li>
                        <li>**ZWNJ/ZWSP/DiÄŸerleri:** Piksel sayÄ±sÄ±nÄ± **69**'a dÃ¼ÅŸÃ¼rÃ¼r, matris boyutu **11x10**.</li>
                        <li>**DENEYSEL (Space+Backspace):** Piksel sayÄ±sÄ±nÄ± **53**'e dÃ¼ÅŸÃ¼rÃ¼r ve matrisi **10x10** olarak yeniden boyutlandÄ±rÄ±r.</li>
                    </ul>
                </li>
                <li style="margin-bottom: 8px;">**KÄ±lavuz AdÄ±m 3 (Kopyalama):** Ã‡iziminizi tamamladÄ±ktan sonra **Panoya Kopyala** butonuna basÄ±n. SeÃ§tiÄŸiniz filtre atlatma karakteri otomatik olarak eklenecektir.</li>
            </ol>
            <button id="close-guide-btn">AnladÄ±m, Kapat</button>
        </div>
    </div>

    <h2 id="main-title">KALP EMOJÄ° PÄ°KSEL SANATI EDÄ°TÃ–RÃœ V.3.1</h2>

    <div id="main-layout">
        <div id="left-panel">
            <div class="card" id="palette">
                <strong>FÄ±rÃ§a Rengi SeÃ§in:</strong>

                <div id="selected-emoji-display">
                    <span style="font-weight: normal;">SeÃ§ili Emoji:</span>
                    <span id="current-brush-emoji">ğŸ–¤</span>
                    <span id="current-brush-name"> (black heart)</span>
                </div>

                <div id="category-tabs">
                </div>

                <div id="emoji-container">
                    <div id="color-options-container">
                    </div>
                </div>
            </div>
        </div>

        <div id="right-panel">
            <div class="card" id="controls-panel">
                 <div id="main-controls" style="margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 10px;">
                    <label for="firstRowLength" style="color: var(--accent-color);">Ä°lk SatÄ±r UzunluÄŸu (0-11):</label>
                    <input type="number" id="firstRowLength" value="6" min="0" max="11" style="width: 70px; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--fixed-bg); color: var(--main-text);">
                    <button id="updateMatrixButton" class="btn-success">Matrisi GÃ¼ncelle</button>
                    <button id="showGuideButton" class="btn-primary">KÄ±lavuz</button>
                </div>

                <div style="margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 10px;">
                    <label for="separator-select" style="color: var(--accent-color); white-space: nowrap;">Filtre Atlatma YÃ¶ntemi:</label>
                    <select id="separator-select">
                        <option value="none">HiÃ§biri (Max 100+ Piksel - 11x10 Matris)</option>
                        <option value="ZWNJ" selected>ZWNJ (Max 69 Piksel - 11x10 Matris)</option>
                        <option value="ZWSP">ZWSP (Max 69 Piksel - 11x10 Matris)</option>
                        <option value="ZWJ">ZWJ (Zero Width Joiner - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="WJ">WJ (Word Joiner - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="SHY">SHY (Soft Hyphen - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="HAIR">Hair Space (Max 69 Piksel - 11x10 Matris)</option>
                        <option value="LRM">LRM (YÃ¶n Kontrol - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="RLM">RLM (YÃ¶n Kontrol - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="ZWNBSP">ZWNBSP (Max 69 Piksel - 11x10 Matris)</option>
                        <option value="LRE">LRE (Bidi L-R-Embedding - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="RLE">RLE (Bidi R-L-Embedding - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="PDF">PDF (Bidi Pop Directional - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="LRI">LRI (Bidi L-R-Isolate - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="RLI">RLI (Bidi R-L-Isolate - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="PDI">PDI (Bidi Pop Isolate - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="CGJ">CGJ (Combining Grapheme Joiner - Max 69 Piksel - 11x10 Matris)</option>
                        <option value="SP_BS">DENEYSEL (Space + Backspace - Max 53 Piksel - 10x10 Matris)</option>
                    </select>
                </div>

                <div id="auxiliary-controls" style="flex-direction: column; gap: 8px; width: 100%;">
                    <button id="copyButton" class="btn-primary" style="width: 100%;">Panoya Kopyala</button>
                    <button id="importButton" class="btn-primary" style="width: 100%;">Panodan Ä°Ã§e Aktar</button>

                    <div style="display: flex; gap: 8px; width: 100%;">
                        <button id="saveButton" class="btn-warning" style="flex-grow: 1;">Kaydet (.txt)</button>
                        <input type="file" id="fileInput" accept=".txt" style="display: none;">
                        <button id="loadButton" class="btn-warning" style="flex-grow: 1;">Dosya AÃ§</button>
                    </div>
                    <button id="clearButton" class="btn-danger" style="width: 100%;">Temizle</button>
                </div>
            </div>

            <div id="info-panel">
                <span class="char-count">KullanÄ±lan GÃ¶rÃ¼nÃ¼r Karakter: <span id="currentChars">0</span>/200</span>
                <span id="charWarning" class="warning" style="display: none;"> - âš ï¸ Ekstra karakter maliyeti!</span>
            </div>

            <div id="matrix-container" style="max-width: 100%;">
                <table id="matrix">
                    </table>
            </div>
        </div>
    </div>

    <script>
        // --- TEMEL TANIMLAMA VE SABÄ°TLER (V3.1 GÃœNCELLEMESÄ°) ---
        const DEFAULT_MATRIX_WIDTH = 11;
        const SP_BS_MATRIX_WIDTH = 10;
        const MATRIX_HEIGHT = 10;
        const MAX_CHARACTERS = 200;
        const EMOJI_JSON_URL = 'emoji.json';
        const defaultHeart = 'ğŸ–¤';

        let currentMatrixWidth = DEFAULT_MATRIX_WIDTH; // Dinamik GeniÅŸlik

        // GÃ–RÃœNMEZ KARAKTER MAP'Ä° (V3.1)
        const SEPARATOR_MAP = {
            'none': '',
            'ZWNJ': '\u200C',
            'ZWSP': '\u200B',
            'ZWJ': '\u200D',
            'WJ': '\u2060',
            'SHY': '\u00AD',
            'HAIR': '\u200A',
            'LRM': '\u200E',
            'RLM': '\u200F',
            'ZWNBSP': '\uFEFF',
            'LRE': '\u202A',
            'RLE': '\u202B',
            'PDF': '\u202C',
            'LRI': '\u2066',
            'RLI': '\u2067',
            'PDI': '\u2069',
            'CGJ': '\u034F',
            'SP_BS': '\u0020\u0008' // Space + Backspace (Deneysel)
        };

        // DENEYSEL OLARAK BULUNAN PÄ°KSEL LÄ°MÄ°TLERÄ°
        const MAX_EMOJI_CELLS_WITH_SEPARATOR = 69;
        const MAX_EMOJI_CELLS_SP_BS = 53;

        let emojiCategories = {};
        let selectedHeart = { emoji: defaultHeart, chars: 1, name: 'black heart' };
        let currentCategory = "";
        let twoCharEmojisUsed = 0;

        // --- DOM ELEMENTLERÄ° ---
        const firstRowLengthInput = document.getElementById('firstRowLength');
        const matrixTable = document.getElementById('matrix');
        const currentCharsSpan = document.getElementById('currentChars');
        const charWarningSpan = document.getElementById('charWarning');
        const guideModal = document.getElementById('guide-modal');
        const showGuideButton = document.getElementById('showGuideButton');
        const closeGuideButton = document.getElementById('close-guide-btn');
        const updateMatrixButton = document.getElementById('updateMatrixButton');
        const copyButton = document.getElementById('copyButton');
        const importButton = document.getElementById('importButton');
        const saveButton = document.getElementById('saveButton');
        const loadButton = document.getElementById('loadButton');
        const fileInput = document.getElementById('fileInput');
        const clearButton = document.getElementById('clearButton');
        const colorOptionsContainer = document.getElementById('color-options-container');
        const categoryTabsContainer = document.getElementById('category-tabs');
        const notification = document.getElementById('notification');
        const confirmModal = document.getElementById('confirm-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        const currentBrushEmoji = document.getElementById('current-brush-emoji');
        const currentBrushName = document.getElementById('current-brush-name');
        const separatorSelect = document.getElementById('separator-select');


        // --- DÄ°ÄER TEMEL FONKSÄ°YONLAR ---

        function showNotification(message, type = 'info', duration = 3000) {
            notification.textContent = message;
            notification.className = '';
            notification.classList.add(type);
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function showConfirm(title, message) {
             return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmModal.classList.add('show');

                modalConfirm.onclick = () => {
                    confirmModal.classList.remove('show');
                    resolve(true);
                };

                modalCancel.onclick = () => {
                    confirmModal.classList.remove('show');
                    resolve(false);
                };
            });
        }

        function calculateChatChars(emojiString) {
            if (emojiString.length > 2) {
                return 2;
            }
            return 1;
        }

        async function loadEmojis() {
             try {
                const response = await fetch(EMOJI_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP Hata kodu: ${response.status}`);
                }
                const rawEmojis = await response.json();

                let processedCategories = {};

                rawEmojis.forEach(item => {
                    const categoryName = item.category || "Uncategorized";
                    const emojiName = item.description || item.names[0];

                    if (!processedCategories[categoryName]) {
                        processedCategories[categoryName] = {};
                    }

                    processedCategories[categoryName][emojiName] = {
                        emoji: item.emoji,
                        chars: calculateChatChars(item.emoji),
                        name: emojiName
                    };
                });

                emojiCategories = processedCategories;

                const sortedCategories = Object.keys(emojiCategories).sort((a, b) =>
                    Object.keys(emojiCategories[b]).length - Object.keys(emojiCategories[a]).length
                );
                currentCategory = sortedCategories[0];

                showNotification(`âœ… ${rawEmojis.length} adet emoji baÅŸarÄ±yla yÃ¼klendi!`, 'success');

            } catch (error) {
                console.error("Emoji yÃ¼kleme hatasÄ±:", error);
                showNotification('âŒ Emoji yÃ¼klenemedi. "emoji.json" dosyasÄ±nÄ±n mevcut ve doÄŸru formatta olduÄŸundan emin olun.', 'error', 8000);
            }
        }

        // --- YARDIMCI Ä°STATÄ°STÄ°K FONKSÄ°YONU ---
        function calculateCurrentStats() {
            let totalChars = 0;
            let localTwoCharEmojisUsed = 0;
            const rows = matrixTable.rows;

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].cells;

                for (let j = 0; j < cells.length; j++) {
                    if (!cells[j].classList.contains('fixed')) {
                        const chars = parseInt(cells[j].getAttribute('data-chars') || '1');
                        totalChars += chars;

                        if (chars === 2) {
                            localTwoCharEmojisUsed++;
                        }
                    }
                }
            }

            return {
                totalChars,
                localTwoCharEmojisUsed,
            };
        }

        // --- MATRÄ°S VE HESAPLAMA FONKSÄ°YONLARI (V3.1 GÃœNCELLEMESÄ°) ---

        function createMatrix() {
            // 1. Matris GeniÅŸliÄŸini GÃ¼ncelle
            currentMatrixWidth = (separatorSelect.value === 'SP_BS') ? SP_BS_MATRIX_WIDTH : DEFAULT_MATRIX_WIDTH;

            matrixTable.innerHTML = '';

            // 2. firstRowLength'i mevcut geniÅŸliÄŸe sÄ±nÄ±rla
            const rawFirstRowLength = parseInt(firstRowLengthInput.value);
            const firstRowLength = Math.min(rawFirstRowLength, currentMatrixWidth);

            // EÄŸer girilen deÄŸer matrisin yeni geniÅŸliÄŸinden fazlaysa inputu gÃ¼ncelle
            if (rawFirstRowLength > currentMatrixWidth) {
                firstRowLengthInput.value = currentMatrixWidth;
            }

            const permanentFixedCount = currentMatrixWidth - firstRowLength;

            for (let rowIndex = 0; rowIndex < MATRIX_HEIGHT; rowIndex++) {
                const row = matrixTable.insertRow();

                for (let colIndex = 0; colIndex < currentMatrixWidth; colIndex++) { // Dinamik GeniÅŸlik
                    const cell = row.insertCell();
                    cell.setAttribute('data-row', rowIndex);
                    cell.setAttribute('data-col', colIndex);

                    const isPermanentlyFixed = (rowIndex === 0 && colIndex < permanentFixedCount);

                    if (isPermanentlyFixed) {
                        cell.innerHTML = 'âŒ';
                        cell.classList.add('fixed');
                    } else {
                        cell.innerHTML = defaultHeart;
                        cell.setAttribute('data-chars', '1');
                        cell.addEventListener('click', () => {
                            handleCellClick(cell);
                        });
                    }
                }
            }
            reorganizeMatrix();
            updateCharacterCount();
        }

        function handleCellClick(cell) {
            if (cell.classList.contains('fixed')) return;

            cell.innerHTML = selectedHeart.emoji;
            cell.setAttribute('data-chars', selectedHeart.chars.toString());

            updateCharacterCount();
        }

        /**
         * Matrisi 69/100/53 kuralÄ±na gÃ¶re yeniden dÃ¼zenler (V3.1 KuralÄ±).
         */
        function reorganizeMatrix() {
            const currentWidth = (separatorSelect.value === 'SP_BS') ? SP_BS_MATRIX_WIDTH : DEFAULT_MATRIX_WIDTH;

            // firstRowLength'i mevcut geniÅŸliÄŸe sÄ±nÄ±rla
            const firstRowLength = Math.min(parseInt(firstRowLengthInput.value), currentWidth);

            const permanentFixedCount = currentWidth - firstRowLength;
            const availableCells = currentWidth * MATRIX_HEIGHT - permanentFixedCount;

            // V3.1 KURALI: KullanÄ±labilecek piksel (emoji) sayÄ±sÄ±
            const separatorValue = separatorSelect.value;
            let targetMaxCells;

            if (separatorValue === 'none') {
                targetMaxCells = availableCells; // KÄ±sÄ±tlama yok
            } else if (separatorValue === 'SP_BS') {
                targetMaxCells = MAX_EMOJI_CELLS_SP_BS; // 53 KuralÄ±
            } else {
                targetMaxCells = MAX_EMOJI_CELLS_WITH_SEPARATOR; // 69 KuralÄ±
            }

            // Toplam sabitlenmesi gereken hÃ¼cre sayÄ±sÄ± (Nickname Offset + Limit KÄ±sÄ±tlamasÄ±)
            const cellsToFixByLimit = Math.max(0, availableCells - targetMaxCells);

            // Sabitlemenin baÅŸladÄ±ÄŸÄ± indis
            const totalCells = currentWidth * MATRIX_HEIGHT;
            const startFixedIndex = totalCells - cellsToFixByLimit;

            let cellIndex = 0;
            for (let i = 0; i < MATRIX_HEIGHT; i++) {
                const rows = matrixTable.rows;
                if (rows[i]) {
                    const cells = rows[i].cells;
                    for (let j = 0; j < cells.length; j++) {
                        const cell = cells[j];

                        const isInitialFixed = (i === 0 && j < permanentFixedCount);
                        const isLimitFixed = (cellIndex >= startFixedIndex);

                        const isFixedZone = isInitialFixed || (isLimitFixed && !isInitialFixed);

                        const isCurrentlyFixed = cell.classList.contains('fixed');

                        if (isFixedZone) {
                            if (!isCurrentlyFixed) {
                                cell.innerHTML = 'âŒ';
                                cell.classList.add('fixed');
                                cell.removeAttribute('data-chars');
                                cell.onclick = null;
                            }
                        } else {
                            if (isCurrentlyFixed) {
                                if (!isInitialFixed) {
                                    cell.innerHTML = defaultHeart;
                                    cell.classList.remove('fixed');
                                    cell.setAttribute('data-chars', '1');
                                    cell.addEventListener('click', () => {
                                        handleCellClick(cell);
                                    });
                                }
                            }
                        }
                        cellIndex++;
                    }
                }
            }
            updateCharacterCount();
        }

        function updateCharacterCount() {
            const stats = calculateCurrentStats();

            twoCharEmojisUsed = stats.localTwoCharEmojisUsed;

            const totalChars = stats.totalChars;

            currentCharsSpan.textContent = totalChars;

            // UYARI METNÄ° GÃœNCELLEME
            if (twoCharEmojisUsed > 0 || separatorSelect.value !== 'none') {
                charWarningSpan.style.display = 'inline';

                const separatorName = separatorSelect.options[separatorSelect.selectedIndex].text;
                const isSeparatorUsed = separatorSelect.value !== 'none';

                let warningText = ` - âš ï¸ `;

                if(twoCharEmojisUsed > 0) {
                     warningText += `${twoCharEmojisUsed} adet 2 karakterlik emoji (Ekstra GÃ¶rÃ¼nÃ¼r Karakter Maliyeti)`;
                }

                if(isSeparatorUsed) {
                    if (twoCharEmojisUsed > 0) warningText += ' ve ';
                    warningText += `${separatorName} ayÄ±rÄ±cÄ±sÄ± kullanÄ±lÄ±yor (Filtre Atlatma).`;
                } else if (twoCharEmojisUsed > 0) {
                    warningText += ' kullanÄ±lÄ±yor.';
                }

                charWarningSpan.textContent = warningText;

            } else {
                charWarningSpan.style.display = 'none';
            }

            if (totalChars > MAX_CHARACTERS) {
                currentCharsSpan.style.color = '#ff6b6b';
                charWarningSpan.innerHTML += ' <strong>âš ï¸ GÃ–RÃœNÃœR KARAKTER LÄ°MÄ°TÄ° AÅILDI!</strong>';
            } else {
                currentCharsSpan.style.color = 'var(--accent-color)';
            }
        }

        // --- PALET VE SEKMELER (DEÄÄ°ÅÄ°KLÄ°K YOK) ---

        function updateSelectedEmojiDisplay() {
            currentBrushEmoji.textContent = selectedHeart.emoji;
            currentBrushName.textContent = ` (${selectedHeart.name})`;

            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected-color'));

            const activeOption = document.querySelector(`[data-color="${selectedHeart.name}"][data-category-name="${currentCategory}"]`);
            if (activeOption) {
                 activeOption.classList.add('selected-color');
            }
        }

        function createCategoryTabs() {
            categoryTabsContainer.innerHTML = '';

            Object.keys(emojiCategories).forEach(categoryName => {
                const tabButton = document.createElement('button');
                tabButton.className = 'category-tab';
                tabButton.textContent = `${categoryName} (${Object.keys(emojiCategories[categoryName]).length})`;
                tabButton.setAttribute('data-category', categoryName);

                if (categoryName === currentCategory) {
                    tabButton.classList.add('active');
                }

                tabButton.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    tabButton.classList.add('active');
                    currentCategory = categoryName;
                    createPalette();
                });

                categoryTabsContainer.appendChild(tabButton);
            });
        }

        function createPalette() {
            colorOptionsContainer.innerHTML = '';

            if (!currentCategory || !emojiCategories[currentCategory]) {
                return;
            }

            const emojisToShow = emojiCategories[currentCategory];

            Object.entries(emojisToShow).forEach(([name, emojiData]) => {
                const span = document.createElement('span');
                span.className = 'color-option';

                if (emojiData.chars === 2) {
                    span.classList.add('two-char-emoji');
                }

                span.innerHTML = emojiData.emoji;
                span.title = `${name} (${emojiData.chars} karakter)`;
                span.setAttribute('data-color', name);
                span.setAttribute('data-chars', emojiData.chars.toString());
                span.setAttribute('data-category-name', currentCategory);

                if (emojiData.emoji === selectedHeart.emoji && emojiData.name === selectedHeart.name) {
                     span.classList.add('selected-color');
                }

                span.addEventListener('click', () => {
                    selectedHeart = emojiData;
                    updateSelectedEmojiDisplay();
                });

                colorOptionsContainer.appendChild(span);
            });

            updateSelectedEmojiDisplay();
        }

        // --- Ä°Ã‡E/DIÅA AKTARMA FONKSÄ°YONLARI ---

        /**
         * Ã‡izimi dÃ¼z emoji metni olarak dÃ¶ndÃ¼rÃ¼r.
         * formatted=false (Kopyalama) durumunda seÃ§ilen ayÄ±rÄ±cÄ±yÄ± ekler.
         */
        function getDrawingText(formatted = false) {
            let result = [];
            const rows = matrixTable.rows;
            // SeÃ§ilen ayÄ±rÄ±cÄ±yÄ± al
            const separatorCode = SEPARATOR_MAP[separatorSelect.value];
            const separator = formatted ? '' : separatorCode;

            for (let i = 0; i < rows.length; i++) {
                let emojisInRow = [];
                const cells = rows[i].cells;

                for (let j = 0; j < cells.length; j++) {
                    if (!cells[j].classList.contains('fixed')) {
                        emojisInRow.push(cells[j].innerHTML);
                    }
                }

                if (emojisInRow.length > 0) {
                    // SatÄ±r iÃ§indeki emojileri seÃ§ilen ayÄ±rÄ±cÄ± ile birleÅŸtir
                    let rowText = emojisInRow.join(separator);
                    result.push(rowText);
                }
            }

            return formatted ? result.join('\n') : result.join('');
        }

        // V3.1: KullanÄ±labilir piksel sayÄ±sÄ±nÄ± (69/53/100+) alÄ±r
        function getAvailablePixelCount() {
            const currentWidth = (separatorSelect.value === 'SP_BS') ? SP_BS_MATRIX_WIDTH : DEFAULT_MATRIX_WIDTH;
            const firstRowLength = Math.min(parseInt(firstRowLengthInput.value), currentWidth);
            const permanentFixedCount = currentWidth - firstRowLength;

            const isSeparatorUsed = separatorSelect.value;
            let targetMaxCells;

            if (isSeparatorUsed === 'none') {
                targetMaxCells = currentWidth * MATRIX_HEIGHT - permanentFixedCount; // KÄ±sÄ±tlama yok
            } else if (isSeparatorUsed === 'SP_BS') {
                targetMaxCells = MAX_EMOJI_CELLS_SP_BS; // 53 KuralÄ±
            } else {
                targetMaxCells = MAX_EMOJI_CELLS_WITH_SEPARATOR; // 69 KuralÄ±
            }

            const availableCells = currentWidth * MATRIX_HEIGHT - permanentFixedCount;

            return Math.min(availableCells, targetMaxCells);
        }

        function applyDrawingText(text) {
            const textWithoutLineBreaks = text.replace(/[\s\n\r]/g, '');

            // 1. AyÄ±rÄ±cÄ±yÄ± tespit et
            let detectedSeparatorKey = 'none';
            const keysToCheck = Object.keys(SEPARATOR_MAP).reverse().filter(k => k !== 'none');

            for (const key of keysToCheck) {
                if (textWithoutLineBreaks.includes(SEPARATOR_MAP[key])) {
                    detectedSeparatorKey = key;
                    break;
                }
            }

            // 2. Dropdown'u otomatik seÃ§
            separatorSelect.value = detectedSeparatorKey;

            // 3. Matrisi yeniden oluÅŸtur (Boyut ve Limitleri ayarlamak iÃ§in)
            // Matris boyutunun deÄŸiÅŸmesi (11x10 -> 10x10) burada halledilir
            createMatrix();

            showNotification(`AyÄ±rÄ±cÄ± ${detectedSeparatorKey} olarak otomatik algÄ±landÄ±. Matris yeniden dÃ¼zenleniyor...`, 'info');

            // 4. TÃ¼m ayÄ±rÄ±cÄ±larÄ± temizle
            const allSeparatorCharacters = Object.values(SEPARATOR_MAP).join('');
            const allSeparatorsRegex = new RegExp(`[${allSeparatorCharacters}]`, 'g');
            const cleanText = textWithoutLineBreaks.replace(allSeparatorsRegex, '');

            // 5. Limit kontrolÃ¼
            const maxPixels = getAvailablePixelCount();
            if (cleanText.length > maxPixels) {
                 showNotification(`Hata: Ä°Ã§e aktarÄ±lan metin ${cleanText.length} emoji iÃ§eriyor. AlgÄ±lanan ayar (Filtre: ${detectedSeparatorKey}) ile izin verilen maksimum emoji sayÄ±sÄ± ${maxPixels}.`, 'error', 7000);
                 return false;
            }

            // 6. Emojileri doldur
            const allEmojis = Object.values(emojiCategories).flatMap(category => Object.values(category));
            let charIndex = 0;
            const rows = matrixTable.rows;

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].cells;

                for (let j = 0; j < cells.length; j++) {
                    const cell = cells[j];

                    if (!cell.classList.contains('fixed') && charIndex < cleanText.length) {

                        let emojiLength = 1;
                        let detectedLength = 1;
                        let foundEmoji = null;
                        let tempString = cleanText.substring(charIndex);

                        // En uzun eÅŸleÅŸen emoji karakterini bul
                        allEmojis.forEach(data => {
                            if (tempString.startsWith(data.emoji)) {
                                if (!foundEmoji || data.emoji.length > foundEmoji.emoji.length) {
                                    foundEmoji = data;
                                    detectedLength = data.chars;
                                }
                            }
                        });

                        if (foundEmoji) {
                            emojiLength = foundEmoji.emoji.length;
                        } else {
                            emojiLength = 1;
                            detectedLength = 1;
                        }

                        cell.innerHTML = cleanText.substring(charIndex, charIndex + emojiLength);
                        cell.setAttribute('data-chars', detectedLength.toString());
                        charIndex += emojiLength;

                    } else if (!cell.classList.contains('fixed') && charIndex >= cleanText.length) {
                        cell.innerHTML = defaultHeart;
                        cell.setAttribute('data-chars', '1');
                    }
                }
            }

            updateCharacterCount();

            const stats = calculateCurrentStats();
            if (stats.totalChars > MAX_CHARACTERS) {
                showNotification(`Hata: Ä°Ã§e aktarÄ±lan metin toplam ${stats.totalChars} gÃ¶rÃ¼nÃ¼r karakter iÃ§eriyor (Limit: ${MAX_CHARACTERS}). Ä°Ã§e aktarma baÅŸarÄ±lÄ± oldu ancak limit aÅŸÄ±ldÄ±!`, 'warning', 7000);
            }

            return true;
        }

        // --- OLAY DÄ°NLEYÄ°CÄ°LERÄ° ---

        updateMatrixButton.addEventListener('click', async () => {
            const confirmed = await showConfirm(
                "Matrisi GÃ¼ncelle",
                "Ä°lk satÄ±r uzunluÄŸunu deÄŸiÅŸtirmek mevcut Ã§izimi temizleyecektir. Devam etmek istiyor musunuz?"
            );

            if (confirmed) {
                twoCharEmojisUsed = 0;
                createMatrix();
                showNotification('Matris baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
            }
        });

        // AyÄ±rÄ±cÄ± deÄŸiÅŸtiÄŸinde matrisi yeniden organize et (V3.1 Dinamik Boyut KontrolÃ¼)
        separatorSelect.addEventListener('change', () => {
            const newWidth = (separatorSelect.value === 'SP_BS') ? SP_BS_MATRIX_WIDTH : DEFAULT_MATRIX_WIDTH;
            const currentDisplayedWidth = matrixTable.rows.length > 0 ? matrixTable.rows[0].cells.length : DEFAULT_MATRIX_WIDTH;

            if (newWidth !== currentDisplayedWidth) {
                 // Matris boyutu deÄŸiÅŸiyorsa, yeniden oluÅŸtur (ve temizle)
                 twoCharEmojisUsed = 0;
                 createMatrix();
                 showNotification(`âš ï¸ Matris boyutu ${currentDisplayedWidth}x${MATRIX_HEIGHT}'dan ${newWidth}x${MATRIX_HEIGHT}'a deÄŸiÅŸtirildi. Ã‡izim temizlendi.`, 'warning');
            } else {
                // Boyut aynÄ±ysa, sadece yeniden dÃ¼zenle (limitleri uygula)
                reorganizeMatrix();
                const separatorName = separatorSelect.options[separatorSelect.selectedIndex].text;
                showNotification(`AyÄ±rÄ±cÄ± ${separatorName} olarak ayarlandÄ±.`, 'info');
            }
        });

        copyButton.addEventListener('click', async () => {
            const drawingText = getDrawingText(false);
            const totalChars = parseInt(currentCharsSpan.textContent);

            // Kopyalama sÄ±rasÄ±nda 69/100/53 kuralÄ±nÄ± kontrol et
            const maxPixels = getAvailablePixelCount();
            const currentPixels = document.querySelectorAll('#matrix td:not(.fixed)').length;

            if (currentPixels > maxPixels) {
                 showNotification(`HATA: Kopyalama baÅŸarÄ±sÄ±z. Matris kuralÄ± ihlali. ${currentPixels}/${maxPixels} piksel.`, 'error', 5000);
                 return;
            }

            if (totalChars > MAX_CHARACTERS) {
                showNotification(`âš ï¸ UYARI: Ã‡iziminiz ${totalChars} gÃ¶rÃ¼nÃ¼r karakter iÃ§eriyor (limit: ${MAX_CHARACTERS}). YouTube'da kesilebilir.`, 'warning', 4000);
                return;
            }

            try {
                const separatorName = separatorSelect.options[separatorSelect.selectedIndex].text;
                await navigator.clipboard.writeText(drawingText);
                showNotification(`âœ… Ã‡izim panoya kopyalandÄ±! (${totalChars}/${MAX_CHARACTERS} gÃ¶rÃ¼nÃ¼r karakter - ${separatorName} kullanÄ±lÄ±yor)`, 'success');
            } catch (err) {
                console.error('Kopyalama baÅŸarÄ±sÄ±z:', err);
                showNotification('âŒ Kopyalama baÅŸarÄ±sÄ±z oldu. LÃ¼tfen tarayÄ±cÄ± izinlerini kontrol edin.', 'error');
            }
        });

        importButton.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (applyDrawingText(text)) {
                    showNotification('âœ… Ã‡izim panodan baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!', 'success');
                }
            } catch (err) {
                console.error('Ä°Ã§e aktarma baÅŸarÄ±sÄ±z:', err);
                showNotification('âŒ Ä°Ã§e aktarma baÅŸarÄ±sÄ±z oldu. Panonuzda geÃ§erli bir Ã§izim metni olduÄŸundan emin olun.', 'error');
            }
        });

        saveButton.addEventListener('click', () => {
            const drawingText = getDrawingText(true);
            const blob = new Blob([drawingText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'emoji_cizimi.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('ğŸ’¾ Ã‡izim baÅŸarÄ±yla kaydedildi!', 'success');
        });

        loadButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    if (applyDrawingText(text)) {
                        showNotification('âœ… Ã‡izim dosyadan baÅŸarÄ±yla yÃ¼klendi!', 'success');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }
        });

        clearButton.addEventListener('click', async () => {
            const confirmed = await showConfirm(
                "Ã‡izimi Temizle",
                "Mevcut Ã§izimi temizlemek istediÄŸinizden emin misiniz?"
            );

            if (confirmed) {
                twoCharEmojisUsed = 0;
                createMatrix();
                showNotification('ğŸ§¹ Ã‡izim temizlendi!', 'success');
            }
        });

        // KÄ±lavuz Modal OlaylarÄ±
        showGuideButton.addEventListener('click', () => {
            guideModal.classList.add('show');
        });

        closeGuideButton.addEventListener('click', () => {
            guideModal.classList.remove('show');
        });

        // --- BAÅLANGIÃ‡ ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadEmojis();

            if (Object.keys(emojiCategories).length > 0) {
                Object.values(emojiCategories).some(category => {
                    return Object.values(category).some(data => {
                        if (data.emoji === defaultHeart) {
                            selectedHeart = data;
                            return true;
                        }
                    });
                });

                updateSelectedEmojiDisplay();
                createMatrix(); // Ä°lk matris oluÅŸturma (11x10 varsayÄ±lan)
                createCategoryTabs();
                createPalette();
                showNotification('âš¡ Kalp Emoji Piksel SanatÄ± EditÃ¶rÃ¼ V.3.1 HazÄ±r!', 'info', 4000);
            } else {
                showNotification('âŒ Uygulama baÅŸlatÄ±lamadÄ±. Emoji verisi yÃ¼klenemedi.', 'error', 5000);
            }

            // KÄ±lavuzu otomatik gÃ¶ster
            guideModal.classList.add('show');
        });
    </script>
</body>
</html>
