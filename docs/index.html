<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalp Emoji Piksel SanatÄ± EditÃ¶rÃ¼</title>
    <style>
        /*
        ========================================
        1. TEMEL VE TEMA TANIMLARI (DARK/LIGHT)
        ========================================
        */
        :root {
            /* Light Mode VarsayÄ±lanlarÄ± */
            --bg-color-light: #f0f3f8;
            --main-text-light: #2c3e50;
            --accent-color-light: #007bff;
            --card-bg-light: rgba(255, 255, 255, 0.85);
            --border-color-light: #e0e6ed;
            --fixed-bg-light: #d4e3f5;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode AyarlarÄ± */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a2e;
                --main-text: #e0eaf1;
                --accent-color: #3f72af; /* Mavi-Mor Tonu */
                --card-bg: rgba(25, 25, 45, 0.85);
                --border-color: #3b3b64;
                --fixed-bg: #2c2c4d;
                --shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            }
        }

        /* Fallback ve Light Mode Uygulama */
        :root {
            --bg-color: var(--bg-color-light);
            --main-text: var(--main-text-light);
            --accent-color: var(--accent-color-light);
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-color-light);
            --fixed-bg: var(--fixed-bg-light);
            --shadow: var(--shadow-light);
        }

        /* Zorunlu Dark Mode (JS ile eklenecek) */
        body.dark-mode {
            --bg-color: #1a1a2e;
            --main-text: #e0eaf1;
            --accent-color: #3f72af;
            --card-bg: rgba(25, 25, 45, 0.85);
            --border-color: #3b3b64;
            --fixed-bg: #2c2c4d;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        /*
        ========================================
        2. ANATOMÄ° VE ARKA PLAN
        ========================================
        */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Space Mono', 'Segoe UI', monospace, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            color: var(--main-text);
            background-color: var(--bg-color);
            transition: background-color 0.5s, color 0.5s;
            position: relative;
            z-index: 1;
        }

        /* FÃ¼tÃ¼ristik Hareketli Arka Plan */
        #background-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.1;
            background:
                linear-gradient(to right, var(--accent-color) 1px, transparent 1px) 0 0,
                linear-gradient(to bottom, var(--accent-color) 1px, transparent 1px) 0 0;
            background-size: 50px 50px;
            animation: grid-flow 60s linear infinite;
        }

        @keyframes grid-flow {
            from { background-position: 0 0; }
            to { background-position: 500px 500px; }
        }

        h2 {
            color: var(--accent-color);
            margin-bottom: 25px;
            font-weight: 700;
            text-align: center;
            width: 100%;
            text-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
            z-index: 2;
        }

        /* Ana Ä°Ã§erik Konteyneri (Desktop YerleÅŸimi iÃ§in) */
        #main-layout {
            display: flex;
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            z-index: 2;
            margin-top: 15px;
        }

        /*
        ========================================
        3. BÄ°LEÅEN STÄ°LLERÄ° (CARD, MATRÄ°S, PALET, MODAL)
        ========================================
        */
        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            transition: background-color 0.5s, border-color 0.5s;
            width: 100%;
        }

        /* Sol Kontrol Paneli (SADECE PALETÄ° Ä°Ã‡ERÄ°R) */
        #left-panel {
            width: 350px;
            flex-shrink: 0;
        }

        /* SaÄŸ Ana Alan (Matris, Bilgi VE KONTROLLER) */
        #right-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* KONTROL PANELÄ° STÄ°LÄ° */
        #controls-panel {
            max-width: 600px;
            margin: 0 auto 20px auto;
            width: 100%;
        }

        /* KÄ±lavuz ve Onay Modal Stilleri */
        #guide-modal, #confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #guide-modal.show, #confirm-modal.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content, .modal-content-guide {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 90%;
            text-align: left;
            border: 2px solid var(--accent-color);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s;
        }

        .modal-btn.confirm { background-color: #28a745; }
        .modal-btn.cancel { background-color: #dc3545; }
        .modal-btn.confirm:hover { background-color: #218838; }
        .modal-btn.cancel:hover { background-color: #c82333; }

        #close-guide-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        /* Bilgi Paneli */
        #info-panel {
            background-color: var(--fixed-bg);
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 800px;
            text-align: center;
            border-left: 4px solid var(--accent-color);
            font-size: 0.9em;
        }

        /* Kontrol ButonlarÄ± */
        #main-controls, #auxiliary-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        /* AyÄ±rÄ±cÄ± SeÃ§imi Stili */
        #separator-select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--fixed-bg);
            color: var(--main-text);
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
        }

        /* DÃ¼ÄŸme stilleri */
        #controls-panel button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            color: var(--main-text);
        }

        .btn-primary { background-color: var(--accent-color); color: white !important;}
        .btn-primary:hover { opacity: 0.85; }
        .btn-success { background-color: #28a745; color: white !important;}
        .btn-success:hover { background-color: #218838; }
        .btn-warning { background-color: #ffc107; color: var(--main-text) !important;}
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: #dc3545; color: white !important;}
        .btn-danger:hover { background-color: #c82333; }

        /* Matris stilleri */
        #matrix-container {
            overflow-x: auto;
            margin-bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
            max-height: 80vh; /* YÃ¼ksek matris iÃ§in limit */
            overflow-y: auto;
        }

        #matrix {
            border-collapse: collapse;
            table-layout: fixed;
            background-color: var(--card-bg);
            border: 4px solid var(--accent-color);
            border-radius: 8px;
            box-shadow: 0 0 20px var(--accent-color), 0 8px 25px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
            transition: background-color 0.5s, border-color 0.5s, box-shadow 0.5s;
        }

        #matrix td {
            width: 35px;
            height: 35px;
            text-align: center;
            vertical-align: middle;
            font-size: 20px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: background-color 0.1s, border-color 0.5s;
        }

        .fixed {
            cursor: not-allowed !important;
            background-color: var(--fixed-bg) !important;
            color: var(--main-text);
            border: 1px solid var(--border-color);
            opacity: 0.7;
        }

        /* KÄ±rpÄ±lan HÃ¼cre Stili (AUTO-CLIPPING) */
        .clipped {
            background-color: rgba(220, 53, 69, 0.3) !important; /* YarÄ± saydam kÄ±rmÄ±zÄ± */
            cursor: not-allowed !important;
            opacity: 0.5;
            position: relative;
            pointer-events: none; /* TÄ±klamayÄ± tamamen devre dÄ±ÅŸÄ± bÄ±rak */
        }
        .clipped:after {
            content: 'âœ‚ï¸';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            pointer-events: none;
        }


        /* Palet Stilleri */
        #palette strong {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--accent-color);
        }

        #selected-emoji-display {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
            padding: 8px;
            border-radius: 4px;
            background-color: var(--fixed-bg);
        }

        #current-brush-emoji {
            font-size: 24px;
        }

        #category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .category-tab {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--fixed-bg);
            color: var(--main-text);
            font-size: 0.85em;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .category-tab.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        #color-options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }

        .color-option {
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: border-color 0.1s;
            position: relative;
        }

        .color-option:hover {
            border-color: var(--accent-color);
        }

        .color-option.selected-color {
            border-color: #ffc107;
            box-shadow: 0 0 5px #ffc107;
        }

        /* Birden fazla karakter maliyeti olan emojiler iÃ§in gÃ¶sterge */
        .multi-char-emoji:before {
            content: attr(data-chars); /* Dinamik olarak uzunluÄŸu gÃ¶ster */
            position: absolute;
            font-size: 8px;
            color: #ff6b6b;
            transform: translate(12px, -8px);
            font-weight: bold;
        }

        /* BÄ°LDÄ°RÄ°M SÄ°STEMÄ° */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 18px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        #notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        #notification.info { background-color: #3f72af; }
        #notification.success { background-color: #28a745; }
        #notification.warning { background-color: #ffc107; color: #333; }
        #notification.error { background-color: #dc3545; }


        /*
        ========================================
        4. RESPONSIVE DÃœZENLEMELER
        ========================================
        */
        @media (max-width: 1024px) {
            #main-layout {
                flex-direction: column;
                gap: 0;
            }
            #left-panel {
                width: 100%;
            }
            #controls-panel {
                max-width: 100%;
                margin: 0 0 20px 0;
            }
            #matrix-container {
                max-height: 60vh; /* Mobil cihazlarda daha az yer kaplama */
            }
        }

        @media (max-width: 600px) {
            #controls-panel > div {
                flex-direction: column;
                align-items: stretch;
            }
            #controls-panel button, #controls-panel input, #controls-panel label, #separator-select {
                width: 100%;
            }
            #auxiliary-controls {
                 flex-direction: row !important;
            }
            #auxiliary-controls button {
                 flex-grow: 1;
            }
        }
    </style>
</head>
<body>

    <div id="background-grid"></div>

    <div id="notification"></div>

    <div id="confirm-modal">
        <div class="modal-content">
            <h3 id="modal-title">Emin misiniz?</h3>
            <p id="modal-message">Bu iÅŸlem geri alÄ±namaz.</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" id="modal-confirm">Evet</button>
                <button class="modal-btn cancel" id="modal-cancel">Ä°ptal</button>
            </div>
        </div>
    </div>

    <div id="guide-modal">
        <div class="modal-content-guide">
            <h3>ğŸ“– YouTube Sohbet KÄ±lavuzu</h3>

            <div style="background-color: var(--fixed-bg); padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid var(--accent-color);">
                <strong>ğŸ¯ Ã–NEMLÄ°:</strong> Uygulama, Ã§iziminizin toplam maliyetinin **200 karakteri** aÅŸmamasÄ±nÄ± otomatik olarak garantiler.
            </div>

            <ol style="margin-left: 20px; font-size: 0.95em;">
                <li style="margin-bottom: 8px;">**KÄ±lavuz AdÄ±m 1 (Ä°lk SatÄ±r AyarÄ±):** YouTube'da 100 adet **ğŸ–¤** gÃ¶nderin. Nickname'inizin yanÄ±nda gÃ¶rÃ¼nen kalp sayÄ±sÄ±nÄ± sayÄ±n. Bu sayÄ±yÄ± **"Ä°lk SatÄ±r UzunluÄŸu"** olarak girin ve **Matrisi GÃ¼ncelle**'ye basÄ±n. **Bu alan (âŒ ile iÅŸaretli) SADECE Ä°LK SATIRDA Ã§Ä±ktÄ±ya dahil edilmez.**</li>
                <li style="margin-bottom: 8px;">**KÄ±lavuz AdÄ±m 2 (Filtre Atlatma):** Ã‡iziminizin YouTube sohbetinde gÃ¶rÃ¼nmemesi durumunda, **Filtre Atlatma YÃ¶ntemi**'ni sÄ±rayla deneyin. Bu karakterler, Ã§iziminizin toplam karakter sayÄ±sÄ±na eklenir.</li>
                <li style="margin-bottom: 8px;">**KÄ±lavuz AdÄ±m 3 (Kopyalama):** Ã‡iziminizi tamamladÄ±ktan sonra **Panoya Kopyala** butonuna basÄ±n. Ã‡Ä±ktÄ±nÄ±zÄ±n 200 karakteri asla aÅŸmadÄ±ÄŸÄ±ndan emin olabilirsiniz. **KÄ±rpÄ±lan (âœ‚ï¸) pikseller Ã§Ä±ktÄ±ya dahil edilmez.**</li>
            </ol>
            <button id="close-guide-btn">AnladÄ±m, Kapat</button>
        </div>
    </div>

    <h2 id="main-title">KALP EMOJÄ° PÄ°KSEL SANATI EDÄ°TÃ–RÃœ V.6.3 (Ä°lk SatÄ±r DÃ¼zeltmesi)</h2>

    <div id="main-layout">
        <div id="left-panel">
            <div class="card" id="palette">
                <strong>FÄ±rÃ§a Rengi SeÃ§in:</strong>

                <div id="selected-emoji-display">
                    <span style="font-weight: normal;">SeÃ§ili Emoji:</span>
                    <span id="current-brush-emoji">ğŸ–¤</span>
                    <span id="current-brush-name"> (black heart)</span>
                </div>

                <div id="category-tabs">
                </div>

                <div id="emoji-container">
                    <div id="color-options-container">
                    </div>
                </div>
            </div>
        </div>

        <div id="right-panel">
            <div class="card" id="controls-panel">
                 <div id="main-controls" style="margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 10px;">
                    <label for="firstRowLength" style="color: var(--accent-color);">Ä°lk SatÄ±r UzunluÄŸu (0-11):</label>
                    <input type="number" id="firstRowLength" value="6" min="0" max="11" style="width: 70px; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--fixed-bg); color: var(--main-text);">
                    <button id="updateMatrixButton" class="btn-success">Matrisi GÃ¼ncelle</button>
                    <button id="showGuideButton" class="btn-primary">KÄ±lavuz</button>
                </div>

                <div style="margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 10px;">
                    <label for="separator-select" style="color: var(--accent-color); white-space: nowrap;">Filtre Atlatma YÃ¶ntemi:</label>
                    <select id="separator-select">
                        <option value="none" selected>HiÃ§biri</option>
                        <option value="ZWNJ">ZWNJ (Zero Width Non-Joiner)</option>
                        <option value="ZWSP">ZWSP (Zero Width Space)</option>
                        <option value="ZWJ">ZWJ (Zero Width Joiner)</option>
                        <option value="WJ">WJ (Word Joiner)</option>
                        <option value="SHY">SHY (Soft Hyphen)</option>
                        <option value="HAIR">Hair Space</option>
                        <option value="LRM">LRM (YÃ¶n Kontrol)</option>
                        <option value="RLM">RLM (YÃ¶n Kontrol)</option>
                        <option value="ZWNBSP">ZWNBSP (Zero Width No-Break Space)</option>
                        <option value="LRE">LRE (Bidi L-R-Embedding)</option>
                        <option value="RLE">RLE (Bidi R-L-Embedding)</option>
                        <option value="PDF">PDF (Bidi Pop Directional)</option>
                        <option value="LRI">LRI (Bidi L-R-Isolate)</option>
                        <option value="RLI">RLI (Bidi R-L-Isolate)</option>
                        <option value="PDI">PDI (Bidi Pop Isolate)</option>
                        <option value="CGJ">CGJ (Combining Grapheme Joiner)</option>
                        <option value="SP_BS">DENEYSEL (Space + Backspace)</option>
                    </select>
                </div>

                <div id="auxiliary-controls" style="flex-direction: column; gap: 8px; width: 100%;">
                    <button id="copyButton" class="btn-primary" style="width: 100%;">Panoya Kopyala</button>
                    <button id="importButton" class="btn-primary" style="width: 100%;">Panodan Ä°Ã§e Aktar</button>

                    <div style="display: flex; gap: 8px; width: 100%;">
                        <button id="saveButton" class="btn-warning" style="flex-grow: 1;">Kaydet (.txt)</button>
                        <input type="file" id="fileInput" accept=".txt" style="display: none;">
                        <button id="loadButton" class="btn-warning" style="flex-grow: 1;">Dosya AÃ§</button>
                    </div>
                    <button id="clearButton" class="btn-danger" style="width: 100%;">Temizle</button>
                </div>
            </div>

            <div id="info-panel">
                <span class="char-count">Toplam Ã‡Ä±ktÄ± Karakteri (Emoji + AyÄ±rÄ±cÄ±): <span id="currentChars">0</span>/200</span>
                <span id="charWarning" class="warning" style="display: none;"> - âš ï¸ Ekstra karakter maliyeti!</span>
            </div>

            <div id="matrix-container" style="max-width: 100%;">
                <table id="matrix">
                    </table>
            </div>
        </div>
    </div>

    <script>
        // --- TEMEL TANIMLAMA VE SABÄ°TLER (V6.3 Ä°LK SATIR DÃœZELTME) ---
        const DEFAULT_MATRIX_WIDTH = 11;
        const SP_BS_MATRIX_WIDTH = 10;
        const MATRIX_HEIGHT = 20; // YÃ¼kseklik 20'de tutulur
        const MAX_CHARACTERS = 200; // YouTube'un genel 200 karakter sÄ±nÄ±rÄ±
        const EMOJI_JSON_URL = 'emoji.json';
        const defaultHeart = 'ğŸ–¤';

        let currentMatrixWidth = DEFAULT_MATRIX_WIDTH;

        /**
         * EMOJÄ°/KARAKTER MALÄ°YETÄ°NÄ° KESÄ°NLÄ°KLE HESAPLAR (UTF-16 kod birimi uzunluÄŸu)
         */
        function calculateChatChars(emojiString) {
            return emojiString.length;
        }

        // AyÄ±rÄ±cÄ± karakterlerin char ve name bilgileri (length artÄ±k dinamik hesaplanacak)
        let SEPARATOR_MAP = {
            'none': { char: '', length: 0, name: 'HiÃ§biri' },
            'ZWNJ': { char: '\u200C', name: 'ZWNJ' },
            'ZWSP': { char: '\u200B', name: 'ZWSP' },
            'ZWJ': { char: '\u200D', name: 'ZWJ' },
            'WJ': { char: '\u2060', name: 'WJ' },
            'SHY': { char: '\u00AD', name: 'SHY' },
            'HAIR': { char: '\u200A', name: 'Hair Space' },
            'LRM': { char: '\u200E', name: 'LRM' },
            'RLM': { char: '\u200F', name: 'RLM' },
            'ZWNBSP': { char: '\uFEFF', name: 'ZWNBSP' },
            'LRE': { char: '\u202A', name: 'LRE' },
            'RLE': { char: '\u202B', name: 'RLE' },
            'PDF': { char: '\u202C', name: 'PDF' },
            'LRI': { char: '\u2066', name: 'LRI' },
            'RLI': { char: '\u2067', name: 'RLI' },
            'PDI': { char: '\u2069', name: 'PDI' },
            'CGJ': { char: '\u034F', name: 'CGJ' },
            'SP_BS': { char: '\u0020\u0008', name: 'Space + Backspace' }
        };

        /**
         * SEPARATOR_MAP'teki ayÄ±rÄ±cÄ±larÄ±n karakter maliyetlerini dinamik olarak hesaplar.
         */
        function calculateSeparatorCharCosts() {
            const separatorSelect = document.getElementById('separator-select');

            for (const key in SEPARATOR_MAP) {
                if (SEPARATOR_MAP.hasOwnProperty(key) && key !== 'none') {
                    const separator = SEPARATOR_MAP[key];
                    // length'i, char'Ä±n gerÃ§ek karakter maliyetiyle gÃ¼ncelle
                    separator.length = calculateChatChars(separator.char);

                    // Dropdown metnini maliyetle gÃ¼ncelle
                    const option = separatorSelect.querySelector(`option[value="${key}"]`);
                    if (option) {
                         option.textContent = `${separator.name} (${separator.length} Karakter)`;
                    }
                }
            }
        }

        // --- DÄ°ÄER TEMEL DEÄÄ°ÅKENLER ---
        let emojiCategories = {};
        let selectedHeart = { emoji: defaultHeart, chars: 0, name: 'black heart' };
        let currentCategory = "";

        // --- DOM ELEMENTLERÄ° ---
        const firstRowLengthInput = document.getElementById('firstRowLength');
        const matrixTable = document.getElementById('matrix');
        const currentCharsSpan = document.getElementById('currentChars');
        const charWarningSpan = document.getElementById('charWarning');
        const guideModal = document.getElementById('guide-modal');
        const showGuideButton = document.getElementById('showGuideButton');
        const closeGuideButton = document.getElementById('close-guide-btn');
        const updateMatrixButton = document.getElementById('updateMatrixButton');
        const copyButton = document.getElementById('copyButton');
        const importButton = document.getElementById('importButton');
        const saveButton = document.getElementById('saveButton');
        const loadButton = document.getElementById('loadButton');
        const fileInput = document.getElementById('fileInput');
        const clearButton = document.getElementById('clearButton');
        const colorOptionsContainer = document.getElementById('color-options-container');
        const categoryTabsContainer = document.getElementById('category-tabs');
        const notification = document.getElementById('notification');
        const confirmModal = document.getElementById('confirm-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        const currentBrushEmoji = document.getElementById('current-brush-emoji');
        const currentBrushName = document.getElementById('current-brush-name');
        const separatorSelect = document.getElementById('separator-select');


        // --- DÄ°ÄER TEMEL FONKSÄ°YONLAR ---

        function showNotification(message, type = 'info', duration = 3000) {
            notification.textContent = message;
            notification.className = '';
            notification.classList.add(type);
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function showConfirm(title, message) {
             return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmModal.classList.add('show');

                modalConfirm.onclick = () => {
                    confirmModal.classList.remove('show');
                    resolve(true);
                };

                modalCancel.onclick = () => {
                    confirmModal.classList.remove('show');
                    resolve(false);
                };
            });
        }

        async function loadEmojis() {
             try {
                // Bu kodun, projenizde 'emoji.json' dosyasÄ±nÄ±n bulunduÄŸunu varsaydÄ±ÄŸÄ±nÄ± unutmayÄ±n.
                // GerÃ§ek bir uygulamada, fetch yerine emoji verilerini doÄŸrudan buraya gÃ¶mmeniz gerekebilir.
                const response = await fetch(EMOJI_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP Hata kodu: ${response.status}`);
                }
                const rawEmojis = await response.json();

                let processedCategories = {};

                rawEmojis.forEach(item => {
                    // Kategori ismini dÃ¼zenle (Ä°lk harf bÃ¼yÃ¼k, diÄŸerleri kÃ¼Ã§Ã¼k)
                    const categoryName = (item.category || "DiÄŸer").charAt(0).toUpperCase() + (item.category || "DiÄŸer").slice(1);
                    const emojiName = item.description || item.names[0];

                    if (!processedCategories[categoryName]) {
                        processedCategories[categoryName] = {};
                    }

                    const charCost = calculateChatChars(item.emoji);

                    processedCategories[categoryName][emojiName] = {
                        emoji: item.emoji,
                        chars: charCost,
                        name: emojiName
                    };
                });

                emojiCategories = processedCategories;

                // BaÅŸlangÄ±Ã§ta en Ã§ok emojisi olan kategoriyi seÃ§
                const sortedCategories = Object.keys(emojiCategories).sort((a, b) =>
                    Object.keys(emojiCategories[b]).length - Object.keys(emojiCategories[a]).length
                );
                currentCategory = sortedCategories[0];

                // BaÅŸlangÄ±Ã§ emojisini gÃ¼ncel, doÄŸru maliyetli objeyle eÅŸleÅŸtir
                const heartData = Object.values(emojiCategories)
                    .flatMap(Object.values)
                    .find(data => data.emoji === defaultHeart);

                if (heartData) {
                    selectedHeart = heartData;
                }

                showNotification(`âœ… ${rawEmojis.length} adet emoji baÅŸarÄ±yla yÃ¼klendi ve maliyetleri hesaplandÄ±!`, 'success');

            } catch (error) {
                console.error("Emoji yÃ¼kleme hatasÄ±:", error);
                showNotification('âŒ Emoji yÃ¼klenemedi. "emoji.json" dosyasÄ±nÄ±n mevcut ve doÄŸru formatta olduÄŸundan emin olun.', 'error', 8000);
            }
        }

        /**
         * Karakter sayÄ±mÄ±nÄ± hesaplar ve bÃ¼tÃ§eyi aÅŸan hÃ¼creleri otomatik olarak kÄ±rpar (clipped).
         * @param {NodeListOf<HTMLTableCellElement>} allCells - Matristeki tÃ¼m hÃ¼creler.
         */
        function calculateAndClip(allCells) {
            let totalEmojiCharCost = 0;
            let totalEmojis = 0;
            let multiCharEmojisUsed = 0;

            const selectedSeparator = SEPARATOR_MAP[separatorSelect.value];

            // Sadece sabit olmayan (fixed) hÃ¼creleri al. Fixed hÃ¼creler Ã§Ä±ktÄ±ya dahil edilmez.
            let editableCells = Array.from(allCells).filter(cell => !cell.classList.contains('fixed'));
            let totalEditableCount = editableCells.length;

            const rawFirstRowLength = parseInt(firstRowLengthInput.value) || 0;
            // Ä°lk satÄ±rda kaÃ§ hÃ¼crenin sabit olduÄŸunu gÃ¶sterir.
            const permanentFixedCount = Math.min(rawFirstRowLength, currentMatrixWidth);

            let clippedCount = 0;

            // KÄ±rpmadan Ã¶nce tÃ¼m kÄ±rpma iÅŸaretlerini temizle
            editableCells.forEach(cell => cell.classList.remove('clipped'));

            let currentRow = -1;
            let emojisInCurrentRow = 0;

            // Ä°kinci dÃ¶ngÃ¼: Karakter bÃ¼tÃ§esini kontrol et ve kÄ±rpma noktasÄ±nÄ± bul/uygula
            for (let i = 0; i < totalEditableCount; i++) {
                const cell = editableCells[i];
                const newRowIndex = parseInt(cell.getAttribute('data-row'));

                // Yeni satÄ±ra geÃ§iÅŸ kontrolÃ¼
                if (newRowIndex !== currentRow) {
                    currentRow = newRowIndex;
                    emojisInCurrentRow = 0; // Yeni satÄ±rda emoji sayÄ±sÄ± sÄ±fÄ±rlanÄ±r
                }

                // AyÄ±rÄ±cÄ± Maliyeti (Sadece emojilerin arasÄ±na konur)
                let separatorCost = 0;

                // Ä°lk SatÄ±r KontrolÃ¼:
                // Ä°lk satÄ±rda (rowIndex === 0) Ã§izilebilir hÃ¼cre sayÄ±sÄ±: (currentMatrixWidth - permanentFixedCount)
                // DiÄŸer satÄ±rlarda (rowIndex > 0) Ã§izilebilir hÃ¼cre sayÄ±sÄ±: currentMatrixWidth

                // BulunduÄŸumuz satÄ±rdaki toplam Ã§izilebilir hÃ¼cre sayÄ±sÄ±
                let effectiveRowWidth = (currentRow === 0)
                    ? (currentMatrixWidth - permanentFixedCount)
                    : currentMatrixWidth;

                // AyÄ±rÄ±cÄ± sadece ilk emojiden sonra (emojisInCurrentRow > 0) konur.
                // AyrÄ±ca, satÄ±r sonuna konmamasÄ± iÃ§in (emojisInCurrentRow < effectiveRowWidth) kontrolÃ¼ yapÄ±lÄ±r.
                if (selectedSeparator.length > 0 && emojisInCurrentRow > 0 && (emojisInCurrentRow < effectiveRowWidth)) {
                    separatorCost = selectedSeparator.length;
                }

                // HÃ¼crenin maliyeti (Drawn state'e gÃ¶re)
                // data-chars, createMatrix veya handleCellClick'te ayarlanÄ±r.
                const emojiCost = parseInt(cell.getAttribute('data-chars') || '1');

                // Toplam maliyet (Emoji + AyÄ±rÄ±cÄ±)
                const combinedCost = emojiCost + separatorCost;

                if (totalEmojiCharCost + combinedCost <= MAX_CHARACTERS) {
                    // BÃ¼tÃ§e dahilinde
                    totalEmojiCharCost += combinedCost;
                    totalEmojis++;
                    emojisInCurrentRow++;

                    if (emojiCost > 1) {
                        multiCharEmojisUsed++;
                    }
                } else {
                    // BÃ¼tÃ§eyi aÅŸÄ±yor, bu hÃ¼creyi ve kalanlarÄ± kÄ±rp
                    clippedCount = totalEditableCount - i; // Kalan tÃ¼m hÃ¼cre sayÄ±sÄ±

                    // Bu hÃ¼creden baÅŸlayarak tÃ¼m kalanlarÄ± kÄ±rp
                    for(let j = i; j < totalEditableCount; j++) {
                        editableCells[j].classList.add('clipped');
                    }
                    break; // KÄ±rpma noktasÄ± bulundu, dÃ¶ngÃ¼den Ã§Ä±k
                }
            }

            // Nihai toplam karakter sayÄ±sÄ± (ASLA 200'Ã¼ aÅŸmaz)
            const totalOutputCharCount = totalEmojiCharCost;

            return {
                totalEmojiCharCost: totalOutputCharCount,
                totalEmojis: totalEmojis,
                multiCharEmojisUsed,
                clippedCount: clippedCount,
                totalOutputCharCount: totalOutputCharCount,
            };
        }

        // --- MATRÄ°S FONKSÄ°YONLARI ---

        function createMatrix() {
            // Matris geniÅŸliÄŸini seÃ§ili ayÄ±rÄ±cÄ±ya gÃ¶re ayarla
            currentMatrixWidth = (separatorSelect.value === 'SP_BS') ? SP_BS_MATRIX_WIDTH : DEFAULT_MATRIX_WIDTH;

            matrixTable.innerHTML = '';

            const rawFirstRowLength = parseInt(firstRowLengthInput.value);
            // Sadece ilk satÄ±rda nickname'in kapladÄ±ÄŸÄ± alanÄ± temsil eder (Fixed HÃ¼cre SayÄ±sÄ±)
            const permanentFixedCount = Math.min(rawFirstRowLength, currentMatrixWidth);

            if (rawFirstRowLength > currentMatrixWidth) {
                firstRowLengthInput.value = currentMatrixWidth;
            }
            firstRowLengthInput.setAttribute('max', currentMatrixWidth.toString());

            const defaultHeartChars = selectedHeart.chars;

            for (let rowIndex = 0; rowIndex < MATRIX_HEIGHT; rowIndex++) {
                const row = matrixTable.insertRow();

                for (let colIndex = 0; colIndex < currentMatrixWidth; colIndex++) {
                    const cell = row.insertCell();
                    cell.setAttribute('data-row', rowIndex);
                    cell.setAttribute('data-col', colIndex);

                    // Sabitlemeyi SADECE Ä°LK SATIRDA (rowIndex === 0) uygula.
                    // Sabit hÃ¼creler daima SOL TARAFTA yer alÄ±r (colIndex < permanentFixedCount).
                    const isPermanentlyFixed = (rowIndex === 0 && colIndex < permanentFixedCount);

                    if (isPermanentlyFixed) {
                        cell.innerHTML = 'âŒ';
                        cell.classList.add('fixed');
                        cell.setAttribute('data-chars', '0'); // Maliyet 0
                    } else {
                        // Ã‡izilebilir alan baÅŸlangÄ±Ã§ta varsayÄ±lan emojiyle dolar
                        cell.innerHTML = selectedHeart.emoji;
                        cell.setAttribute('data-chars', defaultHeartChars.toString());
                        cell.addEventListener('click', () => {
                            handleCellClick(cell);
                        });
                        // KÄ±rpma sÄ±nÄ±fÄ±nÄ± temizle
                        cell.classList.remove('clipped');
                    }
                }
            }

            updateCharacterCount();
        }

        function handleCellClick(cell) {
            // Sadece sabit veya kÄ±rpÄ±lmÄ±ÅŸ deÄŸilse Ã§alÄ±ÅŸtÄ±r
            if (cell.classList.contains('fixed') || cell.classList.contains('clipped')) return;

            const newCost = selectedHeart.chars;

            cell.innerHTML = selectedHeart.emoji;
            cell.setAttribute('data-chars', newCost.toString());

            updateCharacterCount();
        }

        function updateCharacterCount() {
            const allCells = matrixTable.querySelectorAll('td');
            // Maliyeti hesapla ve gerekli hÃ¼creleri otomatik olarak .clipped sÄ±nÄ±fÄ± ile iÅŸaretle
            const stats = calculateAndClip(allCells);

            // UI GÃ¼ncelleme (ASLA 200'Ã¼ aÅŸmayacak)
            const totalOutputCharCount = stats.totalOutputCharCount;

            currentCharsSpan.textContent = totalOutputCharCount;
            // KÄ±rpma yapÄ±ldÄ±ysa, sonuÃ§ 200'dÃ¼r. KÄ±rpma yapÄ±lmadÄ±ysa, 200'den azdÄ±r.
            currentCharsSpan.style.color = (totalOutputCharCount < MAX_CHARACTERS) ? 'var(--accent-color)' : '#28a745';

            // UYARI METNÄ° GÃœNCELLEME
            let warningText = '';
            const selectedSeparator = SEPARATOR_MAP[separatorSelect.value];

            // EÄŸer ayÄ±rÄ±cÄ± kullanÄ±lÄ±yorsa, ayÄ±rÄ±cÄ± maliyeti gÃ¶ster
            if (selectedSeparator.length > 0 && stats.totalEmojis > 0) {
                const totalSeparators = stats.totalEmojis > 0 ? stats.totalEmojis - 1 : 0;
                const separatorCharCost = totalSeparators * selectedSeparator.length;

                warningText += `${selectedSeparator.name} (${separatorCharCost} Karakter Maliyeti) kullanÄ±lÄ±yor.`;
            }

            if (stats.multiCharEmojisUsed > 0) {
                if (warningText) warningText += ' | ';
                 warningText += `${stats.multiCharEmojisUsed} adet Ã§ok karakterli emoji kullanÄ±lÄ±yor.`;
            }

            if (stats.clippedCount > 0) {
                 if (warningText) warningText += ' | ';
                 warningText += `Ã‡IKTI LÄ°MÄ°TÄ° NEDENÄ°YLE SON ${stats.clippedCount} HÃœCRE OTOMATÄ°K KIRPILDI.`;
            }

            if (warningText) {
                charWarningSpan.textContent = ` - âš ï¸ ${warningText}`;
                charWarningSpan.style.display = 'inline';
                charWarningSpan.style.color = stats.clippedCount > 0 ? '#e0a800' : 'var(--main-text)';
            } else {
                charWarningSpan.style.display = 'none';
            }
        }

        // --- PALET VE SEKMELER ---

        function updateSelectedEmojiDisplay() {
            currentBrushEmoji.textContent = selectedHeart.emoji;
            currentBrushName.textContent = ` (${selectedHeart.name} - ${selectedHeart.chars} Karakter Maliyeti)`;

            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected-color'));

            const activeOption = document.querySelector(`[data-color="${selectedHeart.name}"][data-category-name="${currentCategory}"]`);
            if (activeOption) {
                 activeOption.classList.add('selected-color');
            }
        }

        function createCategoryTabs() {
            categoryTabsContainer.innerHTML = '';

            if (!emojiCategories || Object.keys(emojiCategories).length === 0) return;

            Object.keys(emojiCategories).forEach(categoryName => {
                const tabButton = document.createElement('button');
                tabButton.className = 'category-tab';
                tabButton.textContent = `${categoryName} (${Object.keys(emojiCategories[categoryName]).length})`;
                tabButton.setAttribute('data-category', categoryName);

                if (categoryName === currentCategory) {
                    tabButton.classList.add('active');
                }

                tabButton.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    tabButton.classList.add('active');
                    currentCategory = categoryName;
                    createPalette();
                });

                categoryTabsContainer.appendChild(tabButton);
            });
        }

        function createPalette() {
            colorOptionsContainer.innerHTML = '';

            if (!currentCategory || !emojiCategories[currentCategory]) {
                return;
            }

            const emojisToShow = emojiCategories[currentCategory];

            Object.entries(emojisToShow).forEach(([name, emojiData]) => {
                const span = document.createElement('span');
                span.className = 'color-option';

                if (emojiData.chars > 1) {
                    span.classList.add('multi-char-emoji');
                    span.setAttribute('data-chars', emojiData.chars.toString()); // Maliyeti gÃ¶ster
                }

                span.innerHTML = emojiData.emoji;
                span.title = `${name} (${emojiData.chars} karakter maliyeti)`;
                span.setAttribute('data-color', name);
                span.setAttribute('data-chars', emojiData.chars.toString());
                span.setAttribute('data-category-name', currentCategory);

                if (emojiData.emoji === selectedHeart.emoji && emojiData.name === selectedHeart.name) {
                     span.classList.add('selected-color');
                }

                span.addEventListener('click', () => {
                    selectedHeart = emojiData;
                    updateSelectedEmojiDisplay();
                });

                colorOptionsContainer.appendChild(span);
            });

            updateSelectedEmojiDisplay();
        }

        // --- Ä°Ã‡E/DIÅA AKTARMA FONKSÄ°YONLARI ---

        /**
         * Ã‡izimi dÃ¼z emoji metni olarak dÃ¶ndÃ¼rÃ¼r. Sadece kÄ±rpÄ±lmamÄ±ÅŸ (non-clipped) ve fixed olmayan hÃ¼creleri dahil eder.
         */
        function getDrawingText(formatted = false) {
            let result = [];
            const rows = matrixTable.rows;
            const separatorCode = SEPARATOR_MAP[separatorSelect.value].char;
            const separator = formatted ? '' : separatorCode;

            // Sadece sabitlenmemiÅŸ ve kÄ±rpÄ±lmamÄ±ÅŸ hÃ¼creleri dahil et
            for (let i = 0; i < rows.length; i++) {
                let emojisInRow = [];
                const cells = rows[i].cells;
                let isRowClipped = false;
                let rowHasEmoji = false;

                for (let j = 0; j < cells.length; j++) {
                    const cell = cells[j];

                    // Ã–NEMLÄ° DÃœZELTME: Fixed hÃ¼creleri atla (onlar Ã§Ä±ktÄ± metninde yer almayacak)
                    if (cell.classList.contains('fixed')) {
                        continue;
                    }

                    if (cell.classList.contains('clipped')) {
                        isRowClipped = true;
                        // KÄ±rpÄ±lan hÃ¼creye gelindi, bu satÄ±rÄ±n ve sonrasÄ±nÄ±n Ã§Ä±ktÄ±ya dahil edilmemesi gerekir.
                        break;
                    }

                    // Fixed olmayan ve Clipped olmayan hÃ¼creleri ekle
                    emojisInRow.push(cell.innerHTML);
                    rowHasEmoji = true;
                }

                // SatÄ±r Ã§Ä±ktÄ±da yer alacak emojiler iÃ§eriyorsa ekle
                if (rowHasEmoji && !isRowClipped) {
                    let rowText = emojisInRow.join(separator);
                    // formatted=true ise her satÄ±rÄ± ayrÄ± tut
                    result.push(rowText);
                }

                // EÄŸer bu satÄ±rda kÄ±rpÄ±lmÄ±ÅŸ hÃ¼cre varsa, sonraki satÄ±rlara bakmaya gerek yok.
                if (isRowClipped) {
                    break;
                }
            }

            // formatted=false ise, tÃ¼m satÄ±rlarÄ± birleÅŸtirilmiÅŸ tek bir dize dÃ¶ndÃ¼rÃ¼r.
            return formatted ? result.join('\n') : result.join('');
        }

        function applyDrawingText(text) {
            // Txt dosyasÄ±ndan yÃ¼klenen metin satÄ±r sonlarÄ±nÄ± iÃ§erebilir. TÃ¼m whitespace'i kaldÄ±r.
            const textWithoutLineBreaks = text.replace(/[\s\n\r]/g, '');

            // 1. AyÄ±rÄ±cÄ±yÄ± tespit et
            let detectedSeparatorKey = 'none';
            // En uzun ayÄ±rÄ±cÄ±dan baÅŸlayarak kontrol et
            const keysToCheck = Object.keys(SEPARATOR_MAP).reverse().filter(k => k !== 'none');

            for (const key of keysToCheck) {
                const separatorData = SEPARATOR_MAP[key];
                // AyÄ±rÄ±cÄ±nÄ±n gerÃ§ekten bir karakteri varsa ve metinde geÃ§iyorsa
                if (separatorData.char && textWithoutLineBreaks.includes(separatorData.char)) {
                    detectedSeparatorKey = key;
                    break;
                }
            }

            // 2. Dropdown'u otomatik seÃ§
            separatorSelect.value = detectedSeparatorKey;

            // 3. Matrisi yeniden oluÅŸtur (Offset'i ve matris boyutunu ayarlamak iÃ§in)
            // createMatrix, currentMatrixWidth'i yeni ayÄ±rÄ±cÄ±ya gÃ¶re ayarlar ve matrisi temizler.
            createMatrix();

            // 4. AyÄ±rÄ±cÄ±yÄ± temizle
            const selectedSeparator = SEPARATOR_MAP[detectedSeparatorKey];
            const cleanText = textWithoutLineBreaks.split(selectedSeparator.char).join('');

            // 5. Emojileri doldur ve bÃ¼tÃ§eyi koru
            const allEmojis = Object.values(emojiCategories)
                .flatMap(category => Object.values(category))
                .sort((a, b) => b.emoji.length - a.emoji.length); // En uzun eÅŸleÅŸme iÃ§in sÄ±rala

            let charIndex = 0;
            const allCells = matrixTable.querySelectorAll('td');

            // Sadece Ã§izilebilir hÃ¼creleri al (Fixed olmayanlarÄ±)
            let editableCells = Array.from(allCells).filter(cell => !cell.classList.contains('fixed'));
            let totalEditableCount = editableCells.length;

            let currentTotalCharCost = 0;
            const defaultHeartChars = selectedHeart.chars;

            let currentRow = -1;
            let emojisInCurrentRow = 0;
            const rawFirstRowLength = parseInt(firstRowLengthInput.value) || 0;
            const permanentFixedCount = Math.min(rawFirstRowLength, currentMatrixWidth);

            for (let i = 0; i < totalEditableCount; i++) {
                const cell = editableCells[i];
                const newRowIndex = parseInt(cell.getAttribute('data-row'));

                // Yeni satÄ±ra geÃ§iÅŸ kontrolÃ¼
                if (newRowIndex !== currentRow) {
                    currentRow = newRowIndex;
                    emojisInCurrentRow = 0;
                }

                // Metin bittiÄŸi an veya bÃ¼tÃ§e aÅŸÄ±ldÄ±ÄŸÄ± an kÄ±rpmaya baÅŸla
                if (charIndex >= cleanText.length) {
                    // Kalan boÅŸ hÃ¼creleri default emoji ile doldur
                    cell.innerHTML = selectedHeart.emoji;
                    cell.setAttribute('data-chars', defaultHeartChars.toString());
                    cell.classList.remove('clipped');
                    continue;
                }

                let tempString = cleanText.substring(charIndex);
                let emojiLength = 1;
                let detectedCharCost = 1;
                let foundEmoji = null;
                let charContent = tempString.substring(0, 1);

                // En uzun eÅŸleÅŸen emojiyi bul
                for (const data of allEmojis) {
                    if (tempString.startsWith(data.emoji)) {
                        foundEmoji = data;
                        emojiLength = data.emoji.length;
                        detectedCharCost = data.chars;
                        charContent = data.emoji;
                        break;
                    }
                }

                if (!foundEmoji) {
                    // Emoji deÄŸilse/Bulunamazsa, ilk karakteri al
                    detectedCharCost = calculateChatChars(charContent);
                }

                // AyÄ±rÄ±cÄ± Maliyeti (Sadece emojilerin arasÄ±na konur)
                let separatorCost = 0;
                let effectiveRowWidth = (currentRow === 0)
                    ? (currentMatrixWidth - permanentFixedCount)
                    : currentMatrixWidth;

                if (selectedSeparator.length > 0 && emojisInCurrentRow > 0 && (emojisInCurrentRow < effectiveRowWidth)) {
                    separatorCost = selectedSeparator.length;
                }

                const combinedCost = detectedCharCost + separatorCost;

                // BÃœTÃ‡E KONTROLÃœ
                if (currentTotalCharCost + combinedCost <= MAX_CHARACTERS) {
                    // BÃ¼tÃ§e dahilinde
                    cell.innerHTML = charContent;
                    cell.setAttribute('data-chars', detectedCharCost.toString());
                    cell.classList.remove('clipped');
                    currentTotalCharCost += combinedCost;
                    emojisInCurrentRow++;
                    charIndex += emojiLength;
                } else {
                    // BÃ¼tÃ§e aÅŸÄ±ldÄ±: Bu hÃ¼creyi ve kalanlarÄ± kÄ±rp
                    // Kalan hÃ¼creleri kÄ±rpma dÃ¶ngÃ¼sÃ¼
                    for(let j = i; j < totalEditableCount; j++) {
                        editableCells[j].classList.add('clipped');
                        editableCells[j].innerHTML = selectedHeart.emoji; // KÄ±rpÄ±lanlarÄ± default emojiye Ã§evir
                        editableCells[j].setAttribute('data-chars', defaultHeartChars.toString());
                    }
                    break;
                }
            }

            // 6. Karakter sayÄ±mÄ±nÄ± gÃ¼ncelle (Bu Ã§aÄŸrÄ± kÄ±rpma iÅŸlemini kesinleÅŸtirir)
            updateCharacterCount();

            const stats = calculateAndClip(allCells);
            if (stats.clippedCount > 0) {
                 showNotification(`âš ï¸ UYARI: Ä°Ã§e aktarÄ±lan metnin bÃ¼tÃ§eye uyan kÄ±smÄ± yÃ¼klendi. ${stats.clippedCount} hÃ¼cre limit nedeniyle kÄ±rpÄ±ldÄ±.`, 'warning', 7000);
            }

            return true;
        }

        // --- OLAY DÄ°NLEYÄ°CÄ°LERÄ° ---

        firstRowLengthInput.addEventListener('input', () => {
             // Sadece matrisi gÃ¼ncelleme butonuna basÄ±ldÄ±ÄŸÄ±nda matrix yeniden Ã§izilir.
        });


        updateMatrixButton.addEventListener('click', async () => {
            const confirmed = await showConfirm(
                "Matrisi GÃ¼ncelle",
                "Ä°lk satÄ±r uzunluÄŸunu deÄŸiÅŸtirmek mevcut Ã§izimi temizleyecektir. Devam etmek istiyor musunuz?"
            );

            if (confirmed) {
                createMatrix();
                showNotification('Matris baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
            }
        });

        separatorSelect.addEventListener('change', async () => {
            const newWidth = (separatorSelect.value === 'SP_BS') ? SP_BS_MATRIX_WIDTH : DEFAULT_MATRIX_WIDTH;
            const currentDisplayedWidth = matrixTable.rows.length > 0 ? matrixTable.rows[0].cells.length : DEFAULT_MATRIX_WIDTH;

            // EÄŸer matris boyutu deÄŸiÅŸiyorsa (11x20 -> 10x20), matrisi yeniden oluÅŸtur.
            if (newWidth !== currentDisplayedWidth) {
                const confirmed = await showConfirm(
                    "AyÄ±rÄ±cÄ± DeÄŸiÅŸikliÄŸi",
                    "AyÄ±rÄ±cÄ± tÃ¼rÃ¼nÃ¼ deÄŸiÅŸtirmek matris boyutunu deÄŸiÅŸtirecek ve Ã§izimi temizleyecektir. Devam etmek istiyor musunuz?"
                );

                if (confirmed) {
                    createMatrix();
                    showNotification(`âš ï¸ Matris boyutu ${currentDisplayedWidth}x${MATRIX_HEIGHT}'dan ${newWidth}x${MATRIX_HEIGHT}'a deÄŸiÅŸtirildi. Ã‡izim temizlendi.`, 'warning');
                } else {
                    // Ä°ptal edilirse, seÃ§imi eski haline getir
                    const prevValue = Array.from(separatorSelect.options).find(opt =>
                        (opt.value === 'SP_BS' && currentDisplayedWidth === SP_BS_MATRIX_WIDTH) ||
                        (opt.value !== 'SP_BS' && currentDisplayedWidth === DEFAULT_MATRIX_WIDTH)
                    )?.value || 'none';
                    separatorSelect.value = prevValue;
                    return;
                }
            } else {
                // Sadece ayÄ±rÄ±cÄ± deÄŸiÅŸtiyse, karakter sayÄ±mÄ±nÄ± gÃ¼ncelle ve kÄ±rpma iÅŸlemini tekrar Ã§alÄ±ÅŸtÄ±r.
                updateCharacterCount();
                const separatorName = SEPARATOR_MAP[separatorSelect.value].name;
                showNotification(`AyÄ±rÄ±cÄ± ${separatorName} olarak ayarlandÄ±.`, 'info');
            }
        });

        copyButton.addEventListener('click', async () => {
            const drawingText = getDrawingText(false);
            const allCells = matrixTable.querySelectorAll('td');
            const stats = calculateAndClip(allCells);
            const totalChars = stats.totalOutputCharCount;

            try {
                const separatorName = SEPARATOR_MAP[separatorSelect.value].name;
                await navigator.clipboard.writeText(drawingText);
                showNotification(`âœ… Ã‡izim panoya kopyalandÄ±! (${totalChars}/${MAX_CHARACTERS} Karakter - ${separatorName} kullanÄ±lÄ±yor)`, 'success');
            } catch (err) {
                console.error('Kopyalama baÅŸarÄ±sÄ±z:', err);
                showNotification('âŒ Kopyalama baÅŸarÄ±sÄ±z oldu. LÃ¼tfen tarayÄ±cÄ± izinlerini kontrol edin.', 'error');
            }
        });

        importButton.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (text && applyDrawingText(text)) {
                    showNotification('âœ… Ã‡izim panodan baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!', 'success');
                } else if (!text) {
                     showNotification('âŒ Panoda iÃ§e aktarÄ±lacak metin bulunamadÄ±.', 'error');
                }
            } catch (err) {
                console.error('Ä°Ã§e aktarma baÅŸarÄ±sÄ±z:', err);
                showNotification('âŒ Ä°Ã§e aktarma baÅŸarÄ±sÄ±z oldu. Panonuzda geÃ§erli bir Ã§izim metni olduÄŸundan emin olun.', 'error');
            }
        });

        saveButton.addEventListener('click', () => {
            const drawingText = getDrawingText(true);
            const blob = new Blob([drawingText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'emoji_cizimi.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('ğŸ’¾ Ã‡izim baÅŸarÄ±yla kaydedildi!', 'success');
        });

        loadButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    if (applyDrawingText(text)) {
                        showNotification('âœ… Ã‡izim dosyadan baÅŸarÄ±yla yÃ¼klendi!', 'success');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }
        });

        clearButton.addEventListener('click', async () => {
            const confirmed = await showConfirm(
                "Ã‡izimi Temizle",
                "Mevcut Ã§izimi temizlemek istediÄŸinizden emin misiniz?"
            );

            if (confirmed) {
                createMatrix();
                showNotification('ğŸ§¹ Ã‡izim temizlendi!', 'success');
            }
        });

        // KÄ±lavuz Modal OlaylarÄ±
        showGuideButton.addEventListener('click', () => {
            guideModal.classList.add('show');
        });

        closeGuideButton.addEventListener('click', () => {
            guideModal.classList.remove('show');
        });

        // --- BAÅLANGIÃ‡ ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. AyÄ±rÄ±cÄ± maliyetlerini hesapla ve dropdown'u gÃ¼ncelle
            calculateSeparatorCharCosts();

            // 2. VarsayÄ±lan kalbi (ğŸ–¤) maliyetiyle manuel olarak baÅŸlat
            selectedHeart = {
                emoji: defaultHeart,
                chars: calculateChatChars(defaultHeart),
                name: 'black heart'
            };

            // 3. Emojileri yÃ¼kle
            await loadEmojis();

            // 4. Uygulama baÅŸlatma kontrolÃ¼ ve Palet/Matris oluÅŸturma
            if (Object.keys(emojiCategories).length > 0) {
                // loadEmojis iÃ§indeki gÃ¼ncel selectedHeart'Ä± kullan
                updateSelectedEmojiDisplay();
                createMatrix(); // Matris, selectedHeart'Ä±n maliyetini kullanÄ±r
                createCategoryTabs();
                createPalette();
                showNotification('âš¡ Kalp Emoji Piksel SanatÄ± EditÃ¶rÃ¼ V.6.3 HazÄ±r! (Ä°lk SatÄ±r MantÄ±k DÃ¼zeltmesi)', 'info', 4000);
            } else {
                showNotification('âŒ Uygulama baÅŸlatÄ±lamadÄ±. Emoji verisi yÃ¼klenemedi.', 'error', 5000);
            }

            guideModal.classList.add('show');
        });
    </script>
</body>
</html>
